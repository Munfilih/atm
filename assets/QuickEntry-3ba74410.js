import{_ as Z}from"./router-0347d249.js";import{j as e,u as xe,g as me,s as he,a as ge,b as be}from"./index-f4a5a6d3.js";import{R as ce,r as f}from"./vendor-ef1f8636.js";import{d as le,e as ie,T as pe,f as ue,g as je}from"./ui-d671f0b1.js";import"./firebase-ac8704b9.js";const oe=m=>Math.round((m+Number.EPSILON)*100)/100,u=(...m)=>{const x=m.reduce((y,S)=>y+S,0);return oe(x)},de=(m,x)=>oe(m-x),n=m=>{if(m==null||m==="")return 0;const x=Number(m);return isNaN(x)?0:x},ne=["mada","visa","mastercard","gcc"],I=ce.memo(({label:m,value:x})=>e.jsxs("div",{className:"flex justify-between items-center text-sm mb-1",children:[e.jsx("span",{children:m}),e.jsx("span",{className:"font-medium",children:x.toFixed(2)})]})),fe=ce.memo(({machine:m,record:x,records:y,date:S,onClick:L})=>{if(!x){const l=y.filter(b=>b.machineId===m.id&&b.date<S).sort((b,R)=>R.date.localeCompare(b.date))[0],C=l?Number(l.closingBalance||0):0;return e.jsxs("div",{className:"bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow",onClick:L,children:[e.jsx("h3",{className:"font-bold text-lg text-blue-600 mb-3",children:m.name}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded",children:[e.jsx("div",{className:"text-blue-600 font-medium mb-2 border-b border-blue-200 pb-1",children:"Slip"}),e.jsx(I,{label:"Mada",value:0}),e.jsx(I,{label:"Visa",value:0}),e.jsx(I,{label:"MC",value:0}),e.jsx(I,{label:"GCC",value:0}),e.jsx("div",{className:"border-t border-blue-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-blue-600",children:"0.00"})]})})]}),e.jsxs("div",{className:"bg-emerald-50 p-2 rounded",children:[e.jsx("div",{className:"text-emerald-600 font-medium mb-2 border-b border-emerald-200 pb-1",children:"Statement"}),e.jsx(I,{label:"Mada",value:0}),e.jsx(I,{label:"Visa",value:0}),e.jsx(I,{label:"MC",value:0}),e.jsx(I,{label:"GCC",value:0}),e.jsx("div",{className:"border-t border-emerald-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-emerald-600",children:"0.00"})]})})]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Opening: "}),e.jsx("span",{className:`font-bold ${C<0?"text-red-600":"text-green-600"}`,children:C.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Diff: "}),e.jsx("span",{className:"font-bold text-emerald-600",children:"0.00"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Closing: "}),e.jsx("span",{className:`font-bold ${C<0?"text-red-600":"text-green-600"}`,children:C.toFixed(2)})]})]})})]})]})}const d=u(n(x.mada),n(x.visa),n(x.mastercard),n(x.gcc),x.extraFields?Object.values(x.extraFields).reduce((T,l)=>u(T,n(l.slip)),0):0),q=u(n(x.bankMada),n(x.bankVisa),n(x.bankMastercard),n(x.bankGcc),x.extraFields?Object.values(x.extraFields).reduce((T,l)=>u(T,n(l.statement)),0):0),Y=de(q,d);return e.jsxs("div",{className:"bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow",onClick:L,children:[e.jsx("h3",{className:"font-bold text-lg text-blue-600 mb-3",children:m.name}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded",children:[e.jsx("div",{className:"text-blue-600 font-medium mb-2 border-b border-blue-200 pb-1",children:"Slip"}),e.jsx(I,{label:"Mada",value:Number(x.mada||0)}),e.jsx(I,{label:"Visa",value:Number(x.visa||0)}),e.jsx(I,{label:"MC",value:Number(x.mastercard||0)}),e.jsx(I,{label:"GCC",value:Number(x.gcc||0)}),x.extraFields&&Object.entries(x.extraFields).map(([T,l])=>e.jsx(I,{label:T,value:Number(l.slip||0)},`slip-${T}`)),e.jsx("div",{className:"border-t border-blue-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-blue-600",children:d.toFixed(2)})]})})]}),e.jsxs("div",{className:"bg-emerald-50 p-2 rounded",children:[e.jsx("div",{className:"text-emerald-600 font-medium mb-2 border-b border-emerald-200 pb-1",children:"Statement"}),e.jsx(I,{label:"Mada",value:Number(x.bankMada||0)}),e.jsx(I,{label:"Visa",value:Number(x.bankVisa||0)}),e.jsx(I,{label:"MC",value:Number(x.bankMastercard||0)}),e.jsx(I,{label:"GCC",value:Number(x.bankGcc||0)}),x.extraFields&&Object.entries(x.extraFields).map(([T,l])=>e.jsx(I,{label:T,value:Number(l.statement||0)},`stmt-${T}`)),e.jsx("div",{className:"border-t border-emerald-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-emerald-600",children:q.toFixed(2)})]})})]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Opening: "}),e.jsx("span",{className:`font-bold ${(()=>{const l=y.filter(b=>b.machineId===m.id&&b.date<S).sort((b,R)=>R.date.localeCompare(b.date))[0];return(l?Number(l.closingBalance||0):0)<0?"text-red-600":"text-green-600"})()}`,children:(()=>{const l=y.filter(b=>b.machineId===m.id&&b.date<S).sort((b,R)=>R.date.localeCompare(b.date))[0];return(l?Number(l.closingBalance||0):0).toFixed(2)})()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Diff: "}),e.jsx("span",{className:`font-bold ${Y<0?"text-red-600":"text-emerald-600"}`,children:(Y>0?"+":"")+Y.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Closing: "}),e.jsx("span",{className:`font-bold ${(()=>{const l=y.filter(R=>R.machineId===m.id&&R.date<S).sort((R,W)=>W.date.localeCompare(R.date))[0];return(l?Number(l.closingBalance||0):0)+Y<0?"text-red-600":"text-green-600"})()}`,children:(()=>{const l=y.filter(R=>R.machineId===m.id&&R.date<S).sort((R,W)=>W.date.localeCompare(R.date))[0];return((l?Number(l.closingBalance||0):0)+Y).toFixed(2)})()})]})]})})]})]})}),ve=ce.memo(({machine:m,date:x,amounts:y,records:S,initialExtraValues:L,onAmountChange:d,onSave:q,onCancel:Y})=>{const[T,l]=f.useState(()=>{if(!L)return{};const s={};return Object.keys(L).forEach(i=>{const o=i.split(" ")[0].toLowerCase();ne.includes(o)&&(s[o]=[...s[o]||[],i])}),s}),[C,b]=f.useState(L||{}),[R,W]=f.useState(!1),[H,J]=f.useState(0),[A,M]=f.useState(x),[ee,te]=f.useState(!1),z=f.useMemo(()=>S.filter(s=>s.machineId===m.id).sort((s,i)=>s.date.localeCompare(i.date)),[S,m.id]);z[H],f.useEffect(()=>{M(x);const s=z.findIndex(i=>i.date===x);J(s>=0?s:0)},[z,x]);const Q=f.useMemo(()=>{const s=n(y.openingBalance),i=u(n(y.mada),n(y.visa),n(y.mastercard),n(y.gcc)),o=Object.values(C).reduce((r,c)=>u(r,n(c==null?void 0:c.slip)),0),h=u(i,o),p=u(n(y.bankMada),n(y.bankVisa),n(y.bankMastercard),n(y.bankGcc)),t=Object.values(C).reduce((r,c)=>u(r,n(c==null?void 0:c.statement)),0),a=u(p,t);return u(s,de(a,h))},[y,C]),re=s=>{const i=(T[s]||[]).length,o=`${s} ${i+2}`;l(h=>({...h,[s]:[...h[s]||[],o]}))},U=(s,i)=>{l(o=>({...o,[s]:(o[s]||[]).filter(h=>h!==i)})),b(o=>{const h={...o};return delete h[i],h})},K=(s,i,o)=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(s.key)){s.preventDefault();const h=Array.from(document.querySelectorAll("input[data-r]"));let p;if(s.key==="ArrowRight"||s.key==="ArrowLeft"){const t=s.key==="ArrowRight"?o+1:o-1;p=h.find(a=>parseInt(a.dataset.r||"0")===i&&parseInt(a.dataset.c||"0")===t)}else{const t=h.filter(a=>parseInt(a.dataset.c||"0")===o);s.key==="ArrowDown"?p=t.filter(a=>parseInt(a.dataset.r||"0")>i).sort((a,r)=>parseInt(a.dataset.r||"0")-parseInt(r.dataset.r||"0"))[0]:p=t.filter(a=>parseInt(a.dataset.r||"0")<i).sort((a,r)=>parseInt(r.dataset.r||"0")-parseInt(a.dataset.r||"0"))[0]}p&&(p.focus(),p.select())}},ae=async()=>{W(!0);try{await q(C)}catch(s){console.error("Save failed",s)}finally{W(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg p-6 w-full max-w-xl mx-4",children:e.jsxs("form",{onSubmit:s=>s.preventDefault(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{type:"button",onClick:()=>{const s=new Date(A);s.setDate(s.getDate()-1);const i=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;M(i);const o=S.find(t=>t.machineId===m.id&&t.date===i),h=S.filter(t=>t.machineId===m.id&&t.date<i).sort((t,a)=>a.date.localeCompare(t.date)),p=h[0]?String(h[0].closingBalance||0):"0";if(o)if(d("openingBalance",p),d("mada",String(o.mada||"")),d("visa",String(o.visa||"")),d("mastercard",String(o.mastercard||"")),d("gcc",String(o.gcc||"")),d("bankMada",String(o.bankMada||"")),d("bankVisa",String(o.bankVisa||"")),d("bankMastercard",String(o.bankMastercard||"")),d("bankGcc",String(o.bankGcc||"")),o.extraFields){const t={};Object.entries(o.extraFields).forEach(([a,r])=>{const c=r;t[a]={slip:String(c.slip),statement:String(c.statement)}}),b(t)}else b({});else d("openingBalance",p),d("mada",""),d("visa",""),d("mastercard",""),d("gcc",""),d("bankMada",""),d("bankVisa",""),d("bankMastercard",""),d("bankGcc",""),b({})},className:"p-2 hover:bg-gray-100 rounded",children:e.jsx(le,{className:"w-5 h-5"})}),e.jsx("div",{className:"text-center",children:e.jsxs("h3",{className:"text-lg font-bold",children:[m.name," -",e.jsx("button",{type:"button",onClick:()=>te(!ee),className:"text-blue-600 hover:text-blue-800",children:new Date(A).toLocaleDateString("en-US",{weekday:"long",day:"numeric",month:"long",year:"numeric"})})]})}),e.jsx("button",{type:"button",onClick:()=>{const s=new Date(A);s.setDate(s.getDate()+1);const i=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;M(i);const o=S.find(t=>t.machineId===m.id&&t.date===i),h=S.filter(t=>t.machineId===m.id&&t.date<i).sort((t,a)=>a.date.localeCompare(t.date)),p=h[0]?String(h[0].closingBalance||0):"0";if(o)if(d("openingBalance",p),d("mada",String(o.mada||"")),d("visa",String(o.visa||"")),d("mastercard",String(o.mastercard||"")),d("gcc",String(o.gcc||"")),d("bankMada",String(o.bankMada||"")),d("bankVisa",String(o.bankVisa||"")),d("bankMastercard",String(o.bankMastercard||"")),d("bankGcc",String(o.bankGcc||"")),o.extraFields){const t={};Object.entries(o.extraFields).forEach(([a,r])=>{const c=r;t[a]={slip:String(c.slip),statement:String(c.statement)}}),b(t)}else b({});else d("openingBalance",p),d("mada",""),d("visa",""),d("mastercard",""),d("gcc",""),d("bankMada",""),d("bankVisa",""),d("bankMastercard",""),d("bankGcc",""),b({})},className:"p-2 hover:bg-gray-100 rounded",children:e.jsx(ie,{className:"w-5 h-5"})})]}),ee&&e.jsx("div",{className:"mb-4 bg-white rounded-lg shadow-xl border p-4",children:e.jsx("div",{className:"grid grid-cols-7 gap-1",children:(()=>{const s=new Date(A),i=s.getFullYear(),o=s.getMonth(),h=new Date(i,o,1).getDay(),p=new Date(i,o+1,0).getDate(),t=[];for(let a=0;a<h;a++)t.push(e.jsx("div",{className:"aspect-square"},`empty-${a}`));for(let a=1;a<=p;a++){const r=`${i}-${String(o+1).padStart(2,"0")}-${String(a).padStart(2,"0")}`,c=S.find(g=>g.date===r&&g.machineId===m.id),w=r===A,N=!!c,j=c?Number(c.closingBalance||0):0;t.push(e.jsx("button",{onClick:()=>{M(r),te(!1)},className:`aspect-square rounded text-sm transition-all
                          ${w?"bg-blue-600 text-white":"hover:bg-slate-100"}
                          ${N?j<0?"text-red-600":"text-green-600":""}
                        `,children:a},a))}return t})()})}),e.jsx("div",{className:"mb-4 bg-slate-50 p-3 rounded",children:e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Opening Balance: ",e.jsx("strong",{className:Number(y.openingBalance||0)<0?"text-red-600":"text-green-600",children:Number(y.openingBalance||0).toFixed(2)})]}),e.jsxs("span",{children:["Closing Balance: ",e.jsx("strong",{className:Q<0?"text-red-600":"text-green-600",children:Q.toFixed(2)})]})]})}),e.jsxs("div",{className:"space-y-4 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-sm font-medium text-gray-600",children:[e.jsx("div",{children:"Card Type"}),e.jsx("div",{className:"text-center",children:"Slip Amount"}),e.jsx("div",{className:"text-center",children:"Statement Amount"})]}),ne.map((s,i)=>{var o;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e.jsx("label",{className:"text-sm font-medium capitalize",children:s}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{type:"button",onClick:()=>re(s),className:"text-blue-500 hover:text-blue-600 w-7 h-7 flex items-center justify-center flex-shrink-0 text-sm font-bold",tabIndex:-1,children:"+"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:y[s],onChange:h=>d(s,h.target.value),onKeyDown:h=>K(h,i*10,0),"data-r":i*10,"data-c":0,className:"w-full p-3 border rounded text-sm"})]}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:y[`bank${s.charAt(0).toUpperCase()+s.slice(1)}`],onChange:h=>d(`bank${s.charAt(0).toUpperCase()+s.slice(1)}`,h.target.value),onKeyDown:h=>K(h,i*10,1),"data-r":i*10,"data-c":1,className:"w-full p-3 border rounded text-sm"})]}),(o=T[s])==null?void 0:o.map((h,p)=>{var t,a;return e.jsxs("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e.jsxs("div",{className:"text-sm font-medium capitalize pl-8 flex items-center gap-2",children:[e.jsx("span",{children:h}),e.jsx("button",{type:"button",onClick:()=>U(s,h),className:"text-red-500 hover:text-red-700 p-1",title:"Remove field",tabIndex:-1,children:e.jsx(pe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{type:"button",onClick:()=>re(s),className:"text-blue-500 hover:text-blue-600 w-7 h-7 flex items-center justify-center flex-shrink-0 text-sm font-bold",tabIndex:-1,children:"+"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:((t=C[h])==null?void 0:t.slip)||"",onChange:r=>b(c=>({...c,[h]:{...c[h],slip:r.target.value}})),onKeyDown:r=>K(r,i*10+p+1,0),"data-r":i*10+p+1,"data-c":0,className:"w-full p-3 border rounded text-sm"})]}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:((a=C[h])==null?void 0:a.statement)||"",onChange:r=>b(c=>({...c,[h]:{...c[h],statement:r.target.value}})),onKeyDown:r=>K(r,i*10+p+1,1),"data-r":i*10+p+1,"data-c":1,className:"w-full p-3 border rounded text-sm"})]},h)})]},s)}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-sm font-medium border-t pt-3 mt-4",children:[e.jsx("div",{}),e.jsxs("div",{className:"text-center text-blue-600",children:["Total: ",(ne.reduce((s,i)=>u(s,n(y[i])),0)+Object.values(C).reduce((s,i)=>u(s,n(i==null?void 0:i.slip)),0)).toFixed(2)]}),e.jsxs("div",{className:"text-center text-emerald-600",children:["Total: ",(ne.reduce((s,i)=>u(s,n(y[`bank${i.charAt(0).toUpperCase()+i.slice(1)}`])),0)+Object.values(C).reduce((s,i)=>u(s,n(i==null?void 0:i.statement)),0)).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:Y,className:"flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{type:"button",onClick:()=>{Object.keys(y).forEach(s=>{s!=="openingBalance"&&d(s,"")}),b({}),l({})},className:"flex-1 bg-orange-500 text-white p-2 rounded hover:bg-orange-600",children:"Clear"}),e.jsx("button",{type:"button",onClick:ae,disabled:R,className:`flex-1 p-2 rounded flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors ${R?"bg-green-600 text-white":"bg-blue-500 text-white hover:bg-blue-600"}`,children:R?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"w-4 h-4"}),"Save"]})})]})]})})})}),De=()=>{const{user:m}=xe(),[x,y]=f.useState([]),[S,L]=f.useState([]),[d,q]=f.useState(""),[Y,T]=f.useState(!1),[l,C]=f.useState(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}),[b,R]=f.useState({openingBalance:"",mada:"",visa:"",mastercard:"",gcc:"",bankMada:"",bankVisa:"",bankMastercard:"",bankGcc:""}),[W,H]=f.useState({}),[J,A]=f.useState(!1),[M,ee]=f.useState(null),[te,z]=f.useState(!0),[Q,re]=f.useState("");f.useState(!1),f.useState(-1),f.useState(!1);const U=f.useMemo(()=>S.filter(t=>t.date===l),[S,l]),K=f.useMemo(()=>x.find(t=>t.id===d),[x,d]);f.useMemo(()=>Q?S.filter(t=>[t.mada,t.visa,t.mastercard,t.gcc,t.bankMada,t.bankVisa,t.bankMastercard,t.bankGcc].some(a=>a&&a.toString().startsWith(Q))).slice(0,10):[],[S,Q]),f.useEffect(()=>{let t=!0,a=null,r=null;return m?(z(!0),(async()=>{try{const[w,N]=await Promise.all([ge(m.uid),be(m.uid)]);if(t){y(w);const D=N.filter(E=>E.id!=="Yu6wWg6Ui6DrhTJ6VCEk");L(D)}try{const{db:D}=await Z(()=>import("./index-f4a5a6d3.js").then(B=>B.k),["assets/index-f4a5a6d3.js","assets/vendor-ef1f8636.js","assets/router-0347d249.js","assets/firebase-ac8704b9.js","assets/ui-d671f0b1.js","assets/index-487b52d1.css"]),{collection:E,query:F,where:$,onSnapshot:O}=await Z(()=>import("./firebase-ac8704b9.js").then(B=>B.m),[]),v=F(E(D,"machines"),$("userId","==",m.uid));r=O(v,B=>{const k=B.docs.map(V=>({id:V.id,...V.data()}));t&&y(k)},B=>{B.code!=="permission-denied"&&console.error("Machines listener error:",B)});const _=F(E(D,"records"),$("userId","==",m.uid));a=O(_,B=>{const V=B.docs.map(G=>({id:G.id,...G.data()})).filter(G=>G.id!=="Yu6wWg6Ui6DrhTJ6VCEk");t&&L(V)},B=>{B.code!=="permission-denied"&&console.error("Records listener error:",B)})}catch(D){console.error("Firebase listener setup failed:",D)}const{getBusiness:j}=await Z(()=>import("./index-f4a5a6d3.js").then(D=>D.l),["assets/index-f4a5a6d3.js","assets/vendor-ef1f8636.js","assets/router-0347d249.js","assets/firebase-ac8704b9.js","assets/ui-d671f0b1.js","assets/index-487b52d1.css"]),g=await j(m.uid);t&&(ee(g),z(!1))}catch(w){console.error("Error loading data:",w),t&&z(!1)}})()):z(!1),()=>{t=!1,a&&a(),r&&r()}},[m]),f.useEffect(()=>{const t=a=>{const r=a.target;J&&!r.closest(".calendar-container")&&A(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[J]),f.useEffect(()=>{const t=()=>{L(w=>w.filter(N=>N.date!==l))},a=()=>{const w="\uFEFF",N=["Machine","Opening","Slip Mada","Slip Visa","Slip MC","Slip GCC","Bank Mada","Bank Visa","Bank MC","Bank GCC","Difference","Closing"],j=x.map(O=>{const v=U.find(k=>k.machineId===O.id),_=S.filter(k=>k.machineId===O.id&&k.date<l).sort((k,V)=>V.date.localeCompare(k.date)),B=_[0]?Number(_[0].closingBalance||0):0;if(v){const k=Number(v.difference||0),V=B+k;return[O.name,B.toFixed(2),Number(v.mada||0).toFixed(2),Number(v.visa||0).toFixed(2),Number(v.mastercard||0).toFixed(2),Number(v.gcc||0).toFixed(2),Number(v.bankMada||0).toFixed(2),Number(v.bankVisa||0).toFixed(2),Number(v.bankMastercard||0).toFixed(2),Number(v.bankGcc||0).toFixed(2),k.toFixed(2),V.toFixed(2)]}else return[O.name,B.toFixed(2),"0.00","0.00","0.00","0.00","0.00","0.00","0.00","0.00","0.00",B.toFixed(2)]}),g=O=>{const v=String(O||"");return v.includes(",")||v.includes('"')||v.includes(`
`)?`"${v.replace(/"/g,'""')}"`:v},D=w+[N.join(","),...j.map(O=>O.map(g).join(","))].join(`
`),E=new Blob([D],{type:"application/vnd.ms-excel"}),F=URL.createObjectURL(E),$=document.createElement("a");$.style.display="none",$.href=F,$.download=`reconcile-${l}.csv`,$.setAttribute("type","text/csv"),document.body.appendChild($),$.click(),setTimeout(()=>{document.body.removeChild($),URL.revokeObjectURL(F)},100)},r=()=>{window.print()},c=async()=>{try{const{db:w}=await Z(()=>import("./index-f4a5a6d3.js").then(k=>k.k),["assets/index-f4a5a6d3.js","assets/vendor-ef1f8636.js","assets/router-0347d249.js","assets/firebase-ac8704b9.js","assets/ui-d671f0b1.js","assets/index-487b52d1.css"]),{collection:N,query:j,where:g,getDocs:D,deleteDoc:E,doc:F}=await Z(()=>import("./firebase-ac8704b9.js").then(k=>k.m),[]),$=j(N(w,"records"),g("userId","==",(m==null?void 0:m.uid)||""),g("date","==",l)),v=(await D($)).docs.map(k=>E(F(w,"records",k.id)));await Promise.all(v);const B=JSON.parse(localStorage.getItem("rpro_records")||"[]").filter(k=>k.date!==l);localStorage.setItem("rpro_records",JSON.stringify(B)),L(k=>k.filter(V=>V.date!==l))}catch(w){console.error("Error clearing records:",w),alert("Failed to clear records. Please try again.")}};return window.addEventListener("recordsCleared",t),window.addEventListener("exportToExcel",a),window.addEventListener("printDashboard",r),window.addEventListener("clearSelectedDate",c),()=>{window.removeEventListener("recordsCleared",t),window.removeEventListener("exportToExcel",a),window.removeEventListener("printDashboard",r),window.removeEventListener("clearSelectedDate",c)}},[l,x,U,S]);const ae=()=>{R({openingBalance:"",mada:"",visa:"",mastercard:"",gcc:"",bankMada:"",bankVisa:"",bankMastercard:"",bankGcc:""}),H({}),q(""),T(!1)},s=f.useCallback(async t=>{if(!(!m||!d))try{let a=n(b.mada),r=n(b.visa),c=n(b.mastercard),w=n(b.gcc),N=n(b.bankMada),j=n(b.bankVisa),g=n(b.bankMastercard),D=n(b.bankGcc),E=0,F=0;Object.values(t).forEach(P=>{const X=n(P.slip),se=n(P.statement);E=u(E,X),F=u(F,se)});const $=u(a,r,c,w,E),O=u(N,j,g,D,F),v=de(O,$),_=n(b.openingBalance),B=u(_,v),k=U.find(P=>P.machineId===d),V={};Object.entries(t).forEach(([P,X])=>{V[P]={slip:n(X.slip),statement:n(X.statement)}});const G={id:(k==null?void 0:k.id)||me(),userId:m.uid,machineId:d,date:l,openingBalance:_,closingBalance:B,mada:a,visa:r,mastercard:c,gcc:w,bankMada:N,bankVisa:j,bankMastercard:g,bankGcc:D,machineTotal:$,bankCredit:O,difference:v,extraFields:V,timestamp:Date.now()};await he(G),await new Promise(P=>setTimeout(P,500)),L(P=>[...P.filter(se=>!(se.machineId===d&&se.date===l)),G]),window.dispatchEvent(new CustomEvent("reloadRecords")),ae()}catch(a){console.error("Error saving record:",a),alert("Failed to save record. Please try again.")}finally{}},[m,d,b,U,l]),i=f.useCallback((t,a)=>{const r=a||l,c=S.find(g=>g.machineId===t&&g.date===r);q(t);const N=S.filter(g=>g.machineId===t&&g.date<r).sort((g,D)=>D.date.localeCompare(g.date))[0],j=N?String(N.closingBalance||0):"0";if(c)if(R({openingBalance:j,mada:String(c.mada||""),visa:String(c.visa||""),mastercard:String(c.mastercard||""),gcc:String(c.gcc||""),bankMada:String(c.bankMada||""),bankVisa:String(c.bankVisa||""),bankMastercard:String(c.bankMastercard||""),bankGcc:String(c.bankGcc||"")}),c.extraFields){const g={};Object.entries(c.extraFields).forEach(([D,E])=>{const F=E;g[D]={slip:String(F.slip),statement:String(F.statement)}}),H(g)}else H({});else ae(),q(t),R(g=>({...g,openingBalance:j}));T(!0)},[S,l]);f.useEffect(()=>{const t=a=>{const r=a.detail;typeof r=="string"?C(r):(C(r.date),r.machineId&&setTimeout(()=>{i(r.machineId,r.date),T(!0)},50)),A(!1)};return window.addEventListener("navigateToDate",t),()=>{window.removeEventListener("navigateToDate",t)}},[i]);const o=f.useCallback((t,a)=>{R(r=>({...r,[t]:a}))},[]),h=f.useCallback(t=>{const a=new Date(l);a.setDate(a.getDate()+(t==="next"?1:-1));const r=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`;C(r)},[l]),p=f.useMemo(()=>{let t=0,a=0,r=0,c=0,w=0;return x.forEach(N=>{const j=U.find(F=>F.machineId===N.id),D=S.filter(F=>F.machineId===N.id&&F.date<l).sort((F,$)=>$.date.localeCompare(F.date))[0],E=D?n(D.closingBalance):0;if(t=u(t,E),j){const F=n(j.difference),$=u(E,F);a=u(a,$),r=u(r,F);const O=u(u(u(n(j.mada),n(j.visa)),n(j.mastercard)),n(j.gcc)),v=j.extraFields?Object.values(j.extraFields).reduce((G,P)=>u(G,n(P.slip)),0):0,_=u(O,v);c=u(c,_);const B=u(u(u(n(j.bankMada),n(j.bankVisa)),n(j.bankMastercard)),n(j.bankGcc)),k=j.extraFields?Object.values(j.extraFields).reduce((G,P)=>u(G,n(P.statement)),0):0,V=u(B,k);w=u(w,V)}else a=u(a,E)}),{totalOpening:t,totalClosing:a,totalDiff:r,totalSlip:c,totalStatement:w}},[U,x,S,l]);return te?e.jsx("div",{className:"max-w-6xl mx-auto space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 text-center",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("div",{children:"Loading..."})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsxs("div",{className:"print-header",children:[e.jsx("h1",{children:(M==null?void 0:M.name)||"Reconciliation Report"}),e.jsx("p",{children:new Date(l).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}),M&&e.jsxs("p",{children:[M.phone&&e.jsxs("span",{children:[M.phone," | "]}),M.email&&e.jsx("span",{children:M.email})]})]}),e.jsx("div",{className:"print-only",children:e.jsxs("table",{className:"print-table",children:[e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{children:"Machine"}),e.jsx("th",{children:"Opening"}),e.jsx("th",{colSpan:4,style:{textAlign:"center",borderBottom:"1px solid #ddd"},children:"Slip Totals"}),e.jsx("th",{colSpan:4,style:{textAlign:"center",borderBottom:"1px solid #ddd"},children:"Bank Totals"}),e.jsx("th",{children:"Difference"}),e.jsx("th",{children:"Closing"})]}),e.jsxs("tr",{children:[e.jsx("th",{}),e.jsx("th",{}),e.jsx("th",{children:"Mada"}),e.jsx("th",{children:"Visa"}),e.jsx("th",{children:"MC"}),e.jsx("th",{children:"GCC"}),e.jsx("th",{children:"Mada"}),e.jsx("th",{children:"Visa"}),e.jsx("th",{children:"MC"}),e.jsx("th",{children:"GCC"}),e.jsx("th",{}),e.jsx("th",{})]})]}),e.jsx("tbody",{children:x.map(t=>{const a=U.find(N=>N.machineId===t.id),c=S.filter(N=>N.machineId===t.id&&N.date<l).sort((N,j)=>j.date.localeCompare(N.date))[0],w=c?n(c.closingBalance):0;if(a){const N=n(a.difference),j=u(w,N);return e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:"bold"},children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:w.toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.mada).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.visa).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.mastercard).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.gcc).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.bankMada).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.bankVisa).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.bankMastercard).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:n(a.bankGcc).toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:N<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:(N>0?"+":"")+N.toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:j<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:j.toFixed(2)})]},t.id)}else return e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:"bold"},children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:w.toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right",color:w<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:w.toFixed(2)})]},t.id)})}),e.jsx("tfoot",{children:e.jsxs("tr",{style:{borderTop:"2px solid #000",fontWeight:"bold",fontSize:"11pt"},children:[e.jsx("td",{children:"TOTAL"}),e.jsx("td",{style:{textAlign:"right"},children:p.totalOpening.toFixed(2)}),e.jsxs("td",{colSpan:4,style:{textAlign:"center",borderRight:"1px solid #ddd"},children:["Slip: ",p.totalSlip.toFixed(2)]}),e.jsxs("td",{colSpan:4,style:{textAlign:"center",borderRight:"1px solid #ddd"},children:["Statement: ",p.totalStatement.toFixed(2)]}),e.jsx("td",{style:{textAlign:"right",color:p.totalDiff<0?"#dc2626":"#16a34a"},children:(p.totalDiff>0?"+":"")+p.totalDiff.toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:p.totalClosing<0?"#dc2626":"#16a34a"},children:p.totalClosing.toFixed(2)})]})})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 mb-6 no-print",children:[e.jsx("h2",{className:"text-xl font-bold",children:(M==null?void 0:M.name)||"My Business"}),M&&e.jsxs("div",{className:"text-sm text-slate-600 mt-1",children:[M.address&&e.jsxs("span",{children:[M.address," • "]}),M.phone&&e.jsxs("span",{children:[M.phone," • "]}),M.email&&e.jsx("span",{children:M.email}),M.taxId&&e.jsxs("div",{className:"mt-1",children:["Tax ID: ",M.taxId]})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 no-print text-base",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Opening:"}),e.jsx("span",{className:p.totalOpening<0?"text-red-600 font-semibold text-lg":"text-green-600 font-semibold text-lg",children:p.totalOpening.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Difference:"}),e.jsx("span",{className:p.totalDiff<0?"text-red-600 font-semibold text-lg":"text-green-600 font-semibold text-lg",children:(p.totalDiff>0?"+":"")+p.totalDiff.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Closing:"}),e.jsx("span",{className:p.totalClosing<0?"text-red-600 font-bold text-xl":"text-green-600 font-bold text-xl",children:p.totalClosing.toFixed(2)})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow p-4 mb-6 no-print",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>h("prev"),className:"p-2 hover:bg-slate-100 rounded",children:e.jsx(le,{className:"w-4 h-4"})}),e.jsxs("div",{onClick:()=>A(!J),className:"p-2 text-sm font-medium flex items-center gap-2 cursor-pointer hover:bg-slate-50 rounded transition-colors text-black whitespace-nowrap",children:[e.jsx(je,{className:"w-4 h-4"}),new Date(l).toLocaleDateString("en-US",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),e.jsx("button",{onClick:()=>h("next"),className:"p-2 hover:bg-slate-100 rounded",children:e.jsx(ie,{className:"w-4 h-4"})})]})}),J&&e.jsxs("div",{className:"calendar-container mt-4 mb-6 bg-white rounded-lg shadow-xl border p-4 z-50 max-w-sm mx-auto no-print",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{onClick:()=>{const t=new Date(l);t.setMonth(t.getMonth()-1);const a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;C(a)},className:"p-1 hover:bg-slate-100 rounded",children:e.jsx(le,{className:"w-4 h-4"})}),e.jsx("div",{className:"font-semibold",children:new Date(l).toLocaleDateString("en-US",{month:"long",year:"numeric"})}),e.jsx("button",{onClick:()=>{const t=new Date(l);t.setMonth(t.getMonth()+1);const a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;C(a)},className:"p-1 hover:bg-slate-100 rounded",children:e.jsx(ie,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Su","Mo","Tu","We","Th","Fr","Sa"].map(t=>e.jsx("div",{className:"text-center text-xs font-medium text-slate-500 py-1",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:(()=>{const t=new Date(l),a=t.getFullYear(),r=t.getMonth(),c=new Date(a,r,1).getDay(),w=new Date(a,r+1,0).getDate(),N=(()=>{const g=new Date;return`${g.getFullYear()}-${String(g.getMonth()+1).padStart(2,"0")}-${String(g.getDate()).padStart(2,"0")}`})(),j=[];for(let g=0;g<c;g++)j.push(e.jsx("div",{className:"aspect-square"},`empty-${g}`));for(let g=1;g<=w;g++){const D=`${a}-${String(r+1).padStart(2,"0")}-${String(g).padStart(2,"0")}`,E=S.filter(v=>v.date===D);E.some(v=>Number(v.closingBalance||0)<0),E.some(v=>Number(v.closingBalance||0)>0);const F=D===l,$=D===N,O=E.reduce((v,_)=>v+(Number(_.closingBalance)||0),0);j.push(e.jsx("button",{onClick:()=>{C(D),A(!1)},className:`aspect-square rounded-lg text-sm font-medium transition-all relative
                      ${F?"ring-2 ring-blue-600 font-bold":"hover:bg-slate-100"}
                      ${$&&!F?"ring-2 ring-blue-300":""}
                      ${E.length>0?O<0?"text-red-600":"text-green-600":""}
                    `,children:g},g))}return j})()}),e.jsxs("div",{className:"flex items-center justify-center gap-4 mt-4 pt-4 border-t text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsx("span",{className:"text-slate-600",children:"Positive"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsx("span",{className:"text-slate-600",children:"Negative"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-400"}),e.jsx("span",{className:"text-slate-600",children:"Neutral"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 no-print",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:x.map(t=>e.jsx(fe,{machine:t,record:U.find(a=>a.machineId===t.id),records:S,date:l,onClick:()=>i(t.id)},t.id))}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow p-4 mt-4 no-print",children:e.jsxs("div",{className:"flex items-center justify-center gap-8 text-base font-semibold",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Total Slip:"}),e.jsx("span",{className:"text-blue-600 text-lg",children:p.totalSlip.toFixed(2)})]}),e.jsx("div",{className:"h-6 w-px bg-slate-300"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Total Statement:"}),e.jsx("span",{className:"text-purple-600 text-lg",children:p.totalStatement.toFixed(2)})]})]})})]}),Y&&K&&e.jsx(ve,{machine:K,date:l,amounts:b,records:S,initialExtraValues:W,onAmountChange:o,onSave:s,onCancel:()=>T(!1)})]})};export{De as QuickEntry};
