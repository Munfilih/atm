const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-kcVwnAYe.js","assets/router-DrLa08Eq.js","assets/vendor-Bzgz95E1.js","assets/firebase-nYQGFj22.js","assets/ui-Cb5zUclg.js","assets/index-29aAWx0e.css"])))=>i.map(i=>d[i]);
import{u as je,g as fe,s as ve,j as e,a as Ne,b as Se,_ as ne}from"./index-kcVwnAYe.js";import{r as j,R as me}from"./router-DrLa08Eq.js";import{d as oe,e as we,f as xe,T as ye,g as ke}from"./ui-Cb5zUclg.js";import"./vendor-Bzgz95E1.js";import"./firebase-nYQGFj22.js";const ue=x=>Math.round((x+Number.EPSILON)*100)/100,h=(...x)=>{const c=x.reduce((y,S)=>y+S,0);return ue(c)},he=(x,c)=>ue(x-c),a=x=>{if(x==null||x==="")return 0;const c=Number(x);return isNaN(c)?0:c},ce=["mada","visa","mastercard","gcc"],U=me.memo(({label:x,value:c})=>e.jsxs("div",{className:"flex justify-between items-center text-sm mb-1",children:[e.jsx("span",{children:x}),e.jsx("span",{className:"font-medium",children:c.toFixed(2)})]})),De=me.memo(({machine:x,record:c,records:y,date:S,onClick:Y})=>{if(!c){const r=y.filter(m=>m.machineId===x.id&&m.date<S).sort((m,$)=>$.date.localeCompare(m.date))[0],T=r?Number(r.closingBalance||0):0;return e.jsxs("div",{className:"bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow",onClick:Y,children:[e.jsx("h3",{className:"font-bold text-lg text-blue-600 mb-3",children:x.name}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded",children:[e.jsx("div",{className:"text-blue-600 font-medium mb-2 border-b border-blue-200 pb-1",children:"Slip"}),e.jsx(U,{label:"Mada",value:0}),e.jsx(U,{label:"Visa",value:0}),e.jsx(U,{label:"MC",value:0}),e.jsx(U,{label:"GCC",value:0}),e.jsx("div",{className:"border-t border-blue-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-blue-600",children:"0.00"})]})})]}),e.jsxs("div",{className:"bg-emerald-50 p-2 rounded",children:[e.jsx("div",{className:"text-emerald-600 font-medium mb-2 border-b border-emerald-200 pb-1",children:"Statement"}),e.jsx(U,{label:"Mada",value:0}),e.jsx(U,{label:"Visa",value:0}),e.jsx(U,{label:"MC",value:0}),e.jsx(U,{label:"GCC",value:0}),e.jsx("div",{className:"border-t border-emerald-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-emerald-600",children:"0.00"})]})})]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Opening: "}),e.jsx("span",{className:`font-bold ${T<0?"text-red-600":"text-green-600"}`,children:T.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Diff: "}),e.jsx("span",{className:"font-bold text-emerald-600",children:"0.00"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Closing: "}),e.jsx("span",{className:`font-bold ${T<0?"text-red-600":"text-green-600"}`,children:T.toFixed(2)})]})]})})]})]})}const i=h(a(c.mada),a(c.visa),a(c.mastercard),a(c.gcc),c.extraFields?Object.values(c.extraFields).reduce((V,r)=>h(V,a(r.slip)),0):0),J=h(a(c.bankMada),a(c.bankVisa),a(c.bankMastercard),a(c.bankGcc),c.extraFields?Object.values(c.extraFields).reduce((V,r)=>h(V,a(r.statement)),0):0),K=he(J,i);return e.jsxs("div",{className:"bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow",onClick:Y,children:[e.jsx("h3",{className:"font-bold text-lg text-blue-600 mb-3",children:x.name}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded",children:[e.jsx("div",{className:"text-blue-600 font-medium mb-2 border-b border-blue-200 pb-1",children:"Slip"}),e.jsx(U,{label:"Mada",value:Number(c.mada||0)}),e.jsx(U,{label:"Visa",value:Number(c.visa||0)}),e.jsx(U,{label:"MC",value:Number(c.mastercard||0)}),e.jsx(U,{label:"GCC",value:Number(c.gcc||0)}),c.extraFields&&Object.entries(c.extraFields).map(([V,r])=>e.jsx(U,{label:V,value:Number(r.slip||0)},`slip-${V}`)),e.jsx("div",{className:"border-t border-blue-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-blue-600",children:i.toFixed(2)})]})})]}),e.jsxs("div",{className:"bg-emerald-50 p-2 rounded",children:[e.jsx("div",{className:"text-emerald-600 font-medium mb-2 border-b border-emerald-200 pb-1",children:"Statement"}),e.jsx(U,{label:"Mada",value:Number(c.bankMada||0)}),e.jsx(U,{label:"Visa",value:Number(c.bankVisa||0)}),e.jsx(U,{label:"MC",value:Number(c.bankMastercard||0)}),e.jsx(U,{label:"GCC",value:Number(c.bankGcc||0)}),c.extraFields&&Object.entries(c.extraFields).map(([V,r])=>e.jsx(U,{label:V,value:Number(r.statement||0)},`stmt-${V}`)),e.jsx("div",{className:"border-t border-emerald-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-emerald-600",children:J.toFixed(2)})]})})]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Opening: "}),e.jsx("span",{className:`font-bold ${(()=>{const r=y.filter(m=>m.machineId===x.id&&m.date<S).sort((m,$)=>$.date.localeCompare(m.date))[0];return(r?Number(r.closingBalance||0):0)<0?"text-red-600":"text-green-600"})()}`,children:(()=>{const r=y.filter(m=>m.machineId===x.id&&m.date<S).sort((m,$)=>$.date.localeCompare(m.date))[0];return(r?Number(r.closingBalance||0):0).toFixed(2)})()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Diff: "}),e.jsx("span",{className:`font-bold ${K<0?"text-red-600":"text-emerald-600"}`,children:(K>0?"+":"")+K.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Closing: "}),e.jsx("span",{className:`font-bold ${(()=>{const r=y.filter($=>$.machineId===x.id&&$.date<S).sort(($,Q)=>Q.date.localeCompare($.date))[0];return(r?Number(r.closingBalance||0):0)+K<0?"text-red-600":"text-green-600"})()}`,children:(()=>{const r=y.filter($=>$.machineId===x.id&&$.date<S).sort(($,Q)=>Q.date.localeCompare($.date))[0];return((r?Number(r.closingBalance||0):0)+K).toFixed(2)})()})]})]})})]})]})}),Fe=me.memo(({machine:x,date:c,amounts:y,records:S,initialExtraValues:Y,onAmountChange:i,onSave:J,onCancel:K})=>{const[V,r]=j.useState(()=>{if(!Y)return{};const s={};return Object.keys(Y).forEach(l=>{const d=l.split(" ")[0].toLowerCase();ce.includes(d)&&(s[d]=[...s[d]||[],l])}),s}),[T,m]=j.useState(Y||{}),[$,Q]=j.useState(!1),[se,Z]=j.useState(0),[z,B]=j.useState(c),[re,le]=j.useState(!1),H=j.useMemo(()=>S.filter(s=>s.machineId===x.id).sort((s,l)=>s.date.localeCompare(l.date)),[S,x.id]);H[se],j.useEffect(()=>{B(c);const s=H.findIndex(l=>l.date===c);Z(s>=0?s:0)},[H,c]);const ee=j.useMemo(()=>{const s=a(y.openingBalance),l=h(a(y.mada),a(y.visa),a(y.mastercard),a(y.gcc)),d=Object.values(T).reduce((k,E)=>h(k,a(E==null?void 0:E.slip)),0),o=h(l,d),I=h(a(y.bankMada),a(y.bankVisa),a(y.bankMastercard),a(y.bankGcc)),g=Object.values(T).reduce((k,E)=>h(k,a(E==null?void 0:E.statement)),0),b=h(I,g);return h(s,he(b,o))},[y,T]),de=s=>{const l=(V[s]||[]).length,d=`${s} ${l+2}`;r(o=>({...o,[s]:[...o[s]||[],d]}))},ge=(s,l)=>{r(d=>({...d,[s]:(d[s]||[]).filter(o=>o!==l)})),m(d=>{const o={...d};return delete o[l],o})},ae=(s,l,d)=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(s.key)){s.preventDefault();const o=Array.from(document.querySelectorAll("input[data-r]"));let I;if(s.key==="ArrowRight"||s.key==="ArrowLeft"){const g=s.key==="ArrowRight"?d+1:d-1;I=o.find(b=>parseInt(b.dataset.r||"0")===l&&parseInt(b.dataset.c||"0")===g)}else{const g=o.filter(b=>parseInt(b.dataset.c||"0")===d);s.key==="ArrowDown"?I=g.filter(b=>parseInt(b.dataset.r||"0")>l).sort((b,k)=>parseInt(b.dataset.r||"0")-parseInt(k.dataset.r||"0"))[0]:I=g.filter(b=>parseInt(b.dataset.r||"0")<l).sort((b,k)=>parseInt(k.dataset.r||"0")-parseInt(b.dataset.r||"0"))[0]}I&&(I.focus(),I.select())}},be=async()=>{Q(!0);try{await J(T)}catch(s){console.error("Save failed",s)}finally{Q(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg p-6 w-full max-w-xl mx-4",children:e.jsxs("form",{onSubmit:s=>s.preventDefault(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{type:"button",onClick:()=>{const s=new Date(z);s.setDate(s.getDate()-1);const l=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;B(l);const d=S.find(g=>g.machineId===x.id&&g.date===l),o=S.filter(g=>g.machineId===x.id&&g.date<l).sort((g,b)=>b.date.localeCompare(g.date)),I=o[0]?String(o[0].closingBalance||0):"0";if(d)if(i("openingBalance",I),i("mada",String(d.mada||"")),i("visa",String(d.visa||"")),i("mastercard",String(d.mastercard||"")),i("gcc",String(d.gcc||"")),i("bankMada",String(d.bankMada||"")),i("bankVisa",String(d.bankVisa||"")),i("bankMastercard",String(d.bankMastercard||"")),i("bankGcc",String(d.bankGcc||"")),d.extraFields){const g={};Object.entries(d.extraFields).forEach(([b,k])=>{const E=k;g[b]={slip:String(E.slip),statement:String(E.statement)}}),m(g)}else m({});else i("openingBalance",I),i("mada",""),i("visa",""),i("mastercard",""),i("gcc",""),i("bankMada",""),i("bankVisa",""),i("bankMastercard",""),i("bankGcc",""),m({})},className:"p-2 hover:bg-gray-100 rounded",children:e.jsx(oe,{className:"w-5 h-5"})}),e.jsx("div",{className:"text-center",children:e.jsxs("h3",{className:"text-lg font-bold",children:[x.name," -",e.jsx("button",{type:"button",onClick:()=>le(!re),className:"text-blue-600 hover:text-blue-800",children:new Date(z).toLocaleDateString("en-US",{weekday:"long",day:"numeric",month:"long",year:"numeric"})})]})}),e.jsx("button",{type:"button",onClick:()=>{const s=new Date(z);s.setDate(s.getDate()+1);const l=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;B(l);const d=S.find(g=>g.machineId===x.id&&g.date===l),o=S.filter(g=>g.machineId===x.id&&g.date<l).sort((g,b)=>b.date.localeCompare(g.date)),I=o[0]?String(o[0].closingBalance||0):"0";if(d)if(i("openingBalance",I),i("mada",String(d.mada||"")),i("visa",String(d.visa||"")),i("mastercard",String(d.mastercard||"")),i("gcc",String(d.gcc||"")),i("bankMada",String(d.bankMada||"")),i("bankVisa",String(d.bankVisa||"")),i("bankMastercard",String(d.bankMastercard||"")),i("bankGcc",String(d.bankGcc||"")),d.extraFields){const g={};Object.entries(d.extraFields).forEach(([b,k])=>{const E=k;g[b]={slip:String(E.slip),statement:String(E.statement)}}),m(g)}else m({});else i("openingBalance",I),i("mada",""),i("visa",""),i("mastercard",""),i("gcc",""),i("bankMada",""),i("bankVisa",""),i("bankMastercard",""),i("bankGcc",""),m({})},className:"p-2 hover:bg-gray-100 rounded",children:e.jsx(xe,{className:"w-5 h-5"})})]}),re&&e.jsx("div",{className:"mb-4 bg-white rounded-lg shadow-xl border p-4",children:e.jsx("div",{className:"grid grid-cols-7 gap-1",children:(()=>{const s=new Date(z),l=s.getFullYear(),d=s.getMonth(),o=new Date(l,d,1).getDay(),I=new Date(l,d+1,0).getDate(),g=[];for(let b=0;b<o;b++)g.push(e.jsx("div",{className:"aspect-square"},`empty-${b}`));for(let b=1;b<=I;b++){const k=`${l}-${String(d+1).padStart(2,"0")}-${String(b).padStart(2,"0")}`,E=S.find(n=>n.date===k&&n.machineId===x.id),ie=k===z,_=!!E,t=E?Number(E.closingBalance||0):0;g.push(e.jsx("button",{onClick:()=>{B(k),le(!1)},className:`aspect-square rounded text-sm transition-all
                          ${ie?"bg-blue-600 text-white":"hover:bg-slate-100"}
                          ${_?t<0?"text-red-600":"text-green-600":""}
                        `,children:b},b))}return g})()})}),e.jsx("div",{className:"mb-4 bg-slate-50 p-3 rounded",children:e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Opening Balance: ",e.jsx("strong",{className:Number(y.openingBalance||0)<0?"text-red-600":"text-green-600",children:Number(y.openingBalance||0).toFixed(2)})]}),e.jsxs("span",{children:["Closing Balance: ",e.jsx("strong",{className:ee<0?"text-red-600":"text-green-600",children:ee.toFixed(2)})]})]})}),e.jsxs("div",{className:"space-y-4 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-sm font-medium text-gray-600",children:[e.jsx("div",{children:"Card Type"}),e.jsx("div",{className:"text-center",children:"Slip Amount"}),e.jsx("div",{className:"text-center",children:"Statement Amount"})]}),ce.map((s,l)=>{var d;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e.jsx("label",{className:"text-sm font-medium capitalize",children:s}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{type:"button",onClick:()=>de(s),className:"text-blue-500 hover:text-blue-600 w-7 h-7 flex items-center justify-center flex-shrink-0 text-sm font-bold",tabIndex:-1,children:"+"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:y[s],onChange:o=>i(s,o.target.value),onKeyDown:o=>ae(o,l*10,0),"data-r":l*10,"data-c":0,className:"w-full p-3 border rounded text-sm"})]}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:y[`bank${s.charAt(0).toUpperCase()+s.slice(1)}`],onChange:o=>i(`bank${s.charAt(0).toUpperCase()+s.slice(1)}`,o.target.value),onKeyDown:o=>ae(o,l*10,1),"data-r":l*10,"data-c":1,className:"w-full p-3 border rounded text-sm"})]}),(d=V[s])==null?void 0:d.map((o,I)=>{var g,b;return e.jsxs("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e.jsxs("div",{className:"text-sm font-medium capitalize pl-8 flex items-center gap-2",children:[e.jsx("span",{children:o}),e.jsx("button",{type:"button",onClick:()=>ge(s,o),className:"text-red-500 hover:text-red-700 p-1",title:"Remove field",tabIndex:-1,children:e.jsx(ye,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{type:"button",onClick:()=>de(s),className:"text-blue-500 hover:text-blue-600 w-7 h-7 flex items-center justify-center flex-shrink-0 text-sm font-bold",tabIndex:-1,children:"+"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:((g=T[o])==null?void 0:g.slip)||"",onChange:k=>m(E=>({...E,[o]:{...E[o],slip:k.target.value}})),onKeyDown:k=>ae(k,l*10+I+1,0),"data-r":l*10+I+1,"data-c":0,className:"w-full p-3 border rounded text-sm"})]}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:((b=T[o])==null?void 0:b.statement)||"",onChange:k=>m(E=>({...E,[o]:{...E[o],statement:k.target.value}})),onKeyDown:k=>ae(k,l*10+I+1,1),"data-r":l*10+I+1,"data-c":1,className:"w-full p-3 border rounded text-sm"})]},o)})]},s)}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-sm font-medium border-t pt-3 mt-4",children:[e.jsx("div",{}),e.jsxs("div",{className:"text-center text-blue-600",children:["Total: ",(ce.reduce((s,l)=>h(s,a(y[l])),0)+Object.values(T).reduce((s,l)=>h(s,a(l==null?void 0:l.slip)),0)).toFixed(2)]}),e.jsxs("div",{className:"text-center text-emerald-600",children:["Total: ",(ce.reduce((s,l)=>h(s,a(y[`bank${l.charAt(0).toUpperCase()+l.slice(1)}`])),0)+Object.values(T).reduce((s,l)=>h(s,a(l==null?void 0:l.statement)),0)).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:K,className:"flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{type:"button",onClick:()=>{Object.keys(y).forEach(s=>{s!=="openingBalance"&&i(s,"")}),m({}),r({})},className:"flex-1 bg-orange-500 text-white p-2 rounded hover:bg-orange-600",children:"Clear"}),e.jsx("button",{type:"button",onClick:be,disabled:$,className:`flex-1 p-2 rounded flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors ${$?"bg-green-600 text-white":"bg-blue-500 text-white hover:bg-blue-600"}`,children:$?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"w-4 h-4"}),"Save"]})})]})]})})})}),Te=()=>{const{user:x}=je(),[c,y]=j.useState([]),[S,Y]=j.useState([]),[i,J]=j.useState(""),[K,V]=j.useState(!1),[r,T]=j.useState(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}),[m,$]=j.useState({openingBalance:"",mada:"",visa:"",mastercard:"",gcc:"",bankMada:"",bankVisa:"",bankMastercard:"",bankGcc:""}),[Q,se]=j.useState({}),[Z,z]=j.useState(!1),[B,re]=j.useState(null),[le,H]=j.useState(!0),[ee,de]=j.useState(""),[ge,ae]=j.useState(!1),[be,s]=j.useState(-1),[l,d]=j.useState(!1),o=j.useMemo(()=>S.filter(t=>t.date===r),[S,r]),I=j.useMemo(()=>c.find(t=>t.id===i),[c,i]);j.useMemo(()=>ee?S.filter(t=>[t.mada,t.visa,t.mastercard,t.gcc,t.bankMada,t.bankVisa,t.bankMastercard,t.bankGcc].some(n=>n&&n.toString().startsWith(ee))).slice(0,10):[],[S,ee]),j.useEffect(()=>{let t=!0,n=null,f=null;return x?(H(!0),(async()=>{try{const[F,w]=await Promise.all([Ne(x.uid),Se(x.uid)]);if(t){y(F);const M=w.filter(R=>R.id!=="Yu6wWg6Ui6DrhTJ6VCEk");Y(M)}try{const{db:M}=await ne(async()=>{const{db:O}=await import("./index-kcVwnAYe.js").then(N=>N.k);return{db:O}},__vite__mapDeps([0,1,2,3,4,5])),{collection:R,query:C,where:P,onSnapshot:G}=await ne(async()=>{const{collection:O,query:N,where:L,onSnapshot:q}=await import("./firebase-nYQGFj22.js").then(A=>A.l);return{collection:O,query:N,where:L,onSnapshot:q}},[]),v=C(R(M,"machines"),P("userId","==",x.uid));f=G(v,O=>{const N=O.docs.map(L=>({id:L.id,...L.data()}));t&&y(N)},O=>{O.code!=="permission-denied"&&console.error("Machines listener error:",O)});const W=C(R(M,"records"),P("userId","==",x.uid));n=G(W,O=>{const L=O.docs.map(q=>({id:q.id,...q.data()})).filter(q=>q.id!=="Yu6wWg6Ui6DrhTJ6VCEk");t&&Y(L)},O=>{O.code!=="permission-denied"&&console.error("Records listener error:",O)})}catch(M){console.error("Firebase listener setup failed:",M)}const{getBusiness:p}=await ne(async()=>{const{getBusiness:M}=await import("./index-kcVwnAYe.js").then(R=>R.l);return{getBusiness:M}},__vite__mapDeps([0,1,2,3,4,5])),u=await p(x.uid);t&&(re(u),H(!1))}catch(F){console.error("Error loading data:",F),t&&H(!1)}})()):H(!1),()=>{t=!1,n&&n(),f&&f()}},[x]),j.useEffect(()=>{const t=n=>{const f=n.target;Z&&!f.closest(".calendar-container")&&z(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[Z]),j.useEffect(()=>{const t=()=>{Y(F=>F.filter(w=>w.date!==r))},n=()=>{const w=["Machine","Opening","Slip Mada","Slip Visa","Slip MC","Slip GCC","Bank Mada","Bank Visa","Bank MC","Bank GCC","Difference","Closing"],p=c.map(G=>{const v=o.find(N=>N.machineId===G.id),W=S.filter(N=>N.machineId===G.id&&N.date<r).sort((N,L)=>L.date.localeCompare(N.date)),O=W[0]?Number(W[0].closingBalance||0):0;if(v){const N=Number(v.difference||0),L=O+N;return[G.name,O.toFixed(2),Number(v.mada||0).toFixed(2),Number(v.visa||0).toFixed(2),Number(v.mastercard||0).toFixed(2),Number(v.gcc||0).toFixed(2),Number(v.bankMada||0).toFixed(2),Number(v.bankVisa||0).toFixed(2),Number(v.bankMastercard||0).toFixed(2),Number(v.bankGcc||0).toFixed(2),N.toFixed(2),L.toFixed(2)]}else return[G.name,O.toFixed(2),"0.00","0.00","0.00","0.00","0.00","0.00","0.00","0.00","0.00",O.toFixed(2)]}),u=G=>{const v=String(G||"");return v.includes(",")||v.includes('"')||v.includes(`
`)?`"${v.replace(/"/g,'""')}"`:v},M="\uFEFF"+[w.join(","),...p.map(G=>G.map(u).join(","))].join(`
`),R=new Blob([M],{type:"application/vnd.ms-excel"}),C=URL.createObjectURL(R),P=document.createElement("a");P.style.display="none",P.href=C,P.download=`reconcile-${r}.csv`,P.setAttribute("type","text/csv"),document.body.appendChild(P),P.click(),setTimeout(()=>{document.body.removeChild(P),URL.revokeObjectURL(C)},100)},f=()=>{window.print()},D=async()=>{try{const{db:F}=await ne(async()=>{const{db:N}=await import("./index-kcVwnAYe.js").then(L=>L.k);return{db:N}},__vite__mapDeps([0,1,2,3,4,5])),{collection:w,query:p,where:u,getDocs:M,deleteDoc:R,doc:C}=await ne(async()=>{const{collection:N,query:L,where:q,getDocs:A,deleteDoc:X,doc:te}=await import("./firebase-nYQGFj22.js").then(pe=>pe.l);return{collection:N,query:L,where:q,getDocs:A,deleteDoc:X,doc:te}},[]),P=p(w(F,"records"),u("userId","==",(x==null?void 0:x.uid)||""),u("date","==",r)),v=(await M(P)).docs.map(N=>R(C(F,"records",N.id)));await Promise.all(v);const O=JSON.parse(localStorage.getItem("rpro_records")||"[]").filter(N=>N.date!==r);localStorage.setItem("rpro_records",JSON.stringify(O)),Y(N=>N.filter(L=>L.date!==r))}catch(F){console.error("Error clearing records:",F),alert("Failed to clear records. Please try again.")}};return window.addEventListener("recordsCleared",t),window.addEventListener("exportToExcel",n),window.addEventListener("printDashboard",f),window.addEventListener("clearSelectedDate",D),()=>{window.removeEventListener("recordsCleared",t),window.removeEventListener("exportToExcel",n),window.removeEventListener("printDashboard",f),window.removeEventListener("clearSelectedDate",D)}},[r,c,o,S]);const g=()=>{$({openingBalance:"",mada:"",visa:"",mastercard:"",gcc:"",bankMada:"",bankVisa:"",bankMastercard:"",bankGcc:""}),se({}),J(""),V(!1)},b=j.useCallback(async t=>{if(!(!x||!i))try{let n=a(m.mada),f=a(m.visa),D=a(m.mastercard),F=a(m.gcc),w=a(m.bankMada),p=a(m.bankVisa),u=a(m.bankMastercard),M=a(m.bankGcc),R=0,C=0;Object.values(t).forEach(A=>{const X=a(A.slip),te=a(A.statement);R=h(R,X),C=h(C,te)});const P=h(n,f,D,F,R),G=h(w,p,u,M,C),v=he(G,P),W=a(m.openingBalance),O=h(W,v),N=o.find(A=>A.machineId===i),L={};Object.entries(t).forEach(([A,X])=>{L[A]={slip:a(X.slip),statement:a(X.statement)}});const q={id:(N==null?void 0:N.id)||fe(),userId:x.uid,machineId:i,date:r,openingBalance:W,closingBalance:O,mada:n,visa:f,mastercard:D,gcc:F,bankMada:w,bankVisa:p,bankMastercard:u,bankGcc:M,machineTotal:P,bankCredit:G,difference:v,extraFields:L,timestamp:Date.now()};await ve(q),await new Promise(A=>setTimeout(A,500)),Y(A=>[...A.filter(te=>!(te.machineId===i&&te.date===r)),q]),window.dispatchEvent(new CustomEvent("reloadRecords")),g()}catch(n){console.error("Error saving record:",n),alert("Failed to save record. Please try again.")}finally{}},[x,i,m,o,r]),k=j.useCallback((t,n)=>{const f=n||r,D=S.find(u=>u.machineId===t&&u.date===f);J(t);const w=S.filter(u=>u.machineId===t&&u.date<f).sort((u,M)=>M.date.localeCompare(u.date))[0],p=w?String(w.closingBalance||0):"0";if(D)if($({openingBalance:p,mada:String(D.mada||""),visa:String(D.visa||""),mastercard:String(D.mastercard||""),gcc:String(D.gcc||""),bankMada:String(D.bankMada||""),bankVisa:String(D.bankVisa||""),bankMastercard:String(D.bankMastercard||""),bankGcc:String(D.bankGcc||"")}),D.extraFields){const u={};Object.entries(D.extraFields).forEach(([M,R])=>{const C=R;u[M]={slip:String(C.slip),statement:String(C.statement)}}),se(u)}else se({});else g(),J(t),$(u=>({...u,openingBalance:p}));V(!0)},[S,r]);j.useEffect(()=>{const t=n=>{const f=n.detail;typeof f=="string"?T(f):(T(f.date),f.machineId&&setTimeout(()=>{k(f.machineId,f.date),V(!0)},50)),z(!1)};return window.addEventListener("navigateToDate",t),()=>{window.removeEventListener("navigateToDate",t)}},[k]);const E=j.useCallback((t,n)=>{$(f=>({...f,[t]:n}))},[]),ie=j.useCallback(t=>{const n=new Date(r);n.setDate(n.getDate()+(t==="next"?1:-1));const f=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`;T(f)},[r]),_=j.useMemo(()=>{let t=0,n=0,f=0,D=0,F=0;return c.forEach(w=>{const p=o.find(C=>C.machineId===w.id),M=S.filter(C=>C.machineId===w.id&&C.date<r).sort((C,P)=>P.date.localeCompare(C.date))[0],R=M?a(M.closingBalance):0;if(p){const C=a(p.difference),P=h(R,C);t=h(t,R),n=h(n,P),f=h(f,C);const G=h(h(h(a(p.mada),a(p.visa)),a(p.mastercard)),a(p.gcc)),v=p.extraFields?Object.values(p.extraFields).reduce((q,A)=>h(q,a(A.slip)),0):0,W=h(G,v);D=h(D,W);const O=h(h(h(a(p.bankMada),a(p.bankVisa)),a(p.bankMastercard)),a(p.bankGcc)),N=p.extraFields?Object.values(p.extraFields).reduce((q,A)=>h(q,a(A.statement)),0):0,L=h(O,N);F=h(F,L)}else n=h(n,R);t=h(t,R)}),{totalOpening:t,totalClosing:n,totalDiff:f,totalSlip:D,totalStatement:F}},[o,c,S,r]);return le?e.jsx("div",{className:"max-w-6xl mx-auto space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 text-center",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("div",{children:"Loading..."})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsxs("div",{className:"print-header",children:[e.jsx("h1",{children:(B==null?void 0:B.name)||"Reconciliation Report"}),e.jsx("p",{children:new Date(r).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}),B&&e.jsxs("p",{children:[B.phone&&e.jsxs("span",{children:[B.phone," | "]}),B.email&&e.jsx("span",{children:B.email})]})]}),e.jsx("div",{className:"print-only",children:e.jsxs("table",{className:"print-table",children:[e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{children:"Machine"}),e.jsx("th",{children:"Opening"}),e.jsx("th",{colSpan:4,style:{textAlign:"center",borderBottom:"1px solid #ddd"},children:"Slip Totals"}),e.jsx("th",{colSpan:4,style:{textAlign:"center",borderBottom:"1px solid #ddd"},children:"Bank Totals"}),e.jsx("th",{children:"Difference"}),e.jsx("th",{children:"Closing"})]}),e.jsxs("tr",{children:[e.jsx("th",{}),e.jsx("th",{}),e.jsx("th",{children:"Mada"}),e.jsx("th",{children:"Visa"}),e.jsx("th",{children:"MC"}),e.jsx("th",{children:"GCC"}),e.jsx("th",{children:"Mada"}),e.jsx("th",{children:"Visa"}),e.jsx("th",{children:"MC"}),e.jsx("th",{children:"GCC"}),e.jsx("th",{}),e.jsx("th",{})]})]}),e.jsx("tbody",{children:c.map(t=>{const n=o.find(w=>w.machineId===t.id),D=S.filter(w=>w.machineId===t.id&&w.date<r).sort((w,p)=>p.date.localeCompare(w.date))[0],F=D?a(D.closingBalance):0;if(n){const w=a(n.difference),p=h(F,w);return e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:"bold"},children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:F.toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.mada).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.visa).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.mastercard).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.gcc).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.bankMada).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.bankVisa).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.bankMastercard).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:a(n.bankGcc).toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:w<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:(w>0?"+":"")+w.toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:p<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:p.toFixed(2)})]},t.id)}else return e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:"bold"},children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:F.toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right",color:F<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:F.toFixed(2)})]},t.id)})}),e.jsx("tfoot",{children:e.jsxs("tr",{style:{borderTop:"2px solid #000",fontWeight:"bold",fontSize:"11pt"},children:[e.jsx("td",{children:"TOTAL"}),e.jsx("td",{style:{textAlign:"right"},children:_.totalOpening.toFixed(2)}),e.jsxs("td",{colSpan:4,style:{textAlign:"center",borderRight:"1px solid #ddd"},children:["Slip: ",_.totalSlip.toFixed(2)]}),e.jsxs("td",{colSpan:4,style:{textAlign:"center",borderRight:"1px solid #ddd"},children:["Statement: ",_.totalStatement.toFixed(2)]}),e.jsx("td",{style:{textAlign:"right",color:_.totalDiff<0?"#dc2626":"#16a34a"},children:(_.totalDiff>0?"+":"")+_.totalDiff.toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:_.totalClosing<0?"#dc2626":"#16a34a"},children:_.totalClosing.toFixed(2)})]})})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 mb-6 no-print",children:[e.jsx("h2",{className:"text-xl font-bold",children:(B==null?void 0:B.name)||"My Business"}),B&&e.jsxs("div",{className:"text-sm text-slate-600 mt-1",children:[B.address&&e.jsxs("span",{children:[B.address," • "]}),B.phone&&e.jsxs("span",{children:[B.phone," • "]}),B.email&&e.jsx("span",{children:B.email}),B.taxId&&e.jsxs("div",{className:"mt-1",children:["Tax ID: ",B.taxId]})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 no-print text-base",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Opening:"}),e.jsx("span",{className:_.totalOpening<0?"text-red-600 font-semibold text-lg":"text-green-600 font-semibold text-lg",children:_.totalOpening.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Difference:"}),e.jsx("span",{className:_.totalDiff<0?"text-red-600 font-semibold text-lg":"text-green-600 font-semibold text-lg",children:(_.totalDiff>0?"+":"")+_.totalDiff.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Closing:"}),e.jsx("span",{className:_.totalClosing<0?"text-red-600 font-bold text-xl":"text-green-600 font-bold text-xl",children:_.totalClosing.toFixed(2)})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow p-4 mb-6 no-print",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>ie("prev"),className:"p-2 hover:bg-slate-100 rounded",children:e.jsx(oe,{className:"w-4 h-4"})}),e.jsxs("div",{onClick:()=>z(!Z),className:"p-2 text-sm font-medium flex items-center gap-2 cursor-pointer hover:bg-slate-50 rounded transition-colors text-black whitespace-nowrap",children:[e.jsx(we,{className:"w-4 h-4"}),new Date(r).toLocaleDateString("en-US",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),e.jsx("button",{onClick:()=>ie("next"),className:"p-2 hover:bg-slate-100 rounded",children:e.jsx(xe,{className:"w-4 h-4"})})]})}),Z&&e.jsxs("div",{className:"calendar-container mt-4 mb-6 bg-white rounded-lg shadow-xl border p-4 z-50 max-w-sm mx-auto no-print",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{onClick:()=>{const t=new Date(r);t.setMonth(t.getMonth()-1);const n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;T(n)},className:"p-1 hover:bg-slate-100 rounded",children:e.jsx(oe,{className:"w-4 h-4"})}),e.jsx("div",{className:"font-semibold",children:new Date(r).toLocaleDateString("en-US",{month:"long",year:"numeric"})}),e.jsx("button",{onClick:()=>{const t=new Date(r);t.setMonth(t.getMonth()+1);const n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;T(n)},className:"p-1 hover:bg-slate-100 rounded",children:e.jsx(xe,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Su","Mo","Tu","We","Th","Fr","Sa"].map(t=>e.jsx("div",{className:"text-center text-xs font-medium text-slate-500 py-1",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:(()=>{const t=new Date(r),n=t.getFullYear(),f=t.getMonth(),D=new Date(n,f,1).getDay(),F=new Date(n,f+1,0).getDate(),w=(()=>{const u=new Date;return`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}-${String(u.getDate()).padStart(2,"0")}`})(),p=[];for(let u=0;u<D;u++)p.push(e.jsx("div",{className:"aspect-square"},`empty-${u}`));for(let u=1;u<=F;u++){const M=`${n}-${String(f+1).padStart(2,"0")}-${String(u).padStart(2,"0")}`,R=S.filter(v=>v.date===M);R.some(v=>Number(v.closingBalance||0)<0),R.some(v=>Number(v.closingBalance||0)>0);const C=M===r,P=M===w,G=R.reduce((v,W)=>v+(Number(W.closingBalance)||0),0);p.push(e.jsx("button",{onClick:()=>{T(M),z(!1)},className:`aspect-square rounded-lg text-sm font-medium transition-all relative
                      ${C?"ring-2 ring-blue-600 font-bold":"hover:bg-slate-100"}
                      ${P&&!C?"ring-2 ring-blue-300":""}
                      ${R.length>0?G<0?"text-red-600":"text-green-600":""}
                    `,children:u},u))}return p})()}),e.jsxs("div",{className:"flex items-center justify-center gap-4 mt-4 pt-4 border-t text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsx("span",{className:"text-slate-600",children:"Positive"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsx("span",{className:"text-slate-600",children:"Negative"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-400"}),e.jsx("span",{className:"text-slate-600",children:"Neutral"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 no-print",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:c.map(t=>e.jsx(De,{machine:t,record:o.find(n=>n.machineId===t.id),records:S,date:r,onClick:()=>k(t.id)},t.id))}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow p-4 mt-4 no-print",children:e.jsxs("div",{className:"flex items-center justify-center gap-8 text-base font-semibold",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Total Slip:"}),e.jsx("span",{className:"text-blue-600 text-lg",children:_.totalSlip.toFixed(2)})]}),e.jsx("div",{className:"h-6 w-px bg-slate-300"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Total Statement:"}),e.jsx("span",{className:"text-purple-600 text-lg",children:_.totalStatement.toFixed(2)})]})]})})]}),K&&I&&e.jsx(Fe,{machine:I,date:r,amounts:m,records:S,initialExtraValues:Q,onAmountChange:E,onSave:b,onCancel:()=>V(!1)})]})};export{Te as QuickEntry};
