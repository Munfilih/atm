import{_ as H}from"./router-3413067a.js";import{j as e,u as pe,g as ne,a as be,s as je,b as fe}from"./index-b47b5198.js";import{R as xe,r as h}from"./vendor-26985c70.js";import{c as W,s as v,p as i,a as re,b as ge,d as ue,e as X,f as Z,g as ve}from"./balanceCalculationService-0d5308fb.js";import{c as me,d as he,T as Ne,e as we,f as Se}from"./ui-2e713e73.js";import"./supabase-101da91f.js";const le=["mada","visa","mastercard","gcc"],k=xe.memo(({label:m,value:u})=>e.jsxs("div",{className:"flex justify-between items-center text-sm mb-1",children:[e.jsx("span",{children:m}),e.jsx("span",{className:"font-medium",children:u.toFixed(2)})]})),ye=({machine:m,record:u,records:w,date:c,onClick:O})=>{if(!u){const j=W(m.id,c,w);return e.jsxs("div",{className:"bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow",onClick:O,children:[e.jsx("h3",{className:"font-bold text-lg text-blue-600 mb-3",children:m.name}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded",children:[e.jsx("div",{className:"text-blue-600 font-medium mb-2 border-b border-blue-200 pb-1",children:"Slip"}),e.jsx(k,{label:"Mada",value:0}),e.jsx(k,{label:"Visa",value:0}),e.jsx(k,{label:"MC",value:0}),e.jsx(k,{label:"GCC",value:0}),e.jsx("div",{className:"border-t border-blue-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-blue-600",children:"0.00"})]})})]}),e.jsxs("div",{className:"bg-emerald-50 p-2 rounded",children:[e.jsx("div",{className:"text-emerald-600 font-medium mb-2 border-b border-emerald-200 pb-1",children:"Statement"}),e.jsx(k,{label:"Mada",value:0}),e.jsx(k,{label:"Visa",value:0}),e.jsx(k,{label:"MC",value:0}),e.jsx(k,{label:"GCC",value:0}),e.jsx("div",{className:"border-t border-emerald-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-emerald-600",children:"0.00"})]})})]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Opening: "}),e.jsx("span",{className:`font-bold ${j<0?"text-red-600":"text-green-600"}`,children:j.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Diff: "}),e.jsx("span",{className:"font-bold text-emerald-600",children:"0.00"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Closing: "}),e.jsx("span",{className:`font-bold ${j<0?"text-red-600":"text-green-600"}`,children:j.toFixed(2)})]})]})}),e.jsx("div",{className:"pt-2 border-t mt-2",children:e.jsxs("div",{className:"flex justify-between items-center text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Slip: "}),e.jsx("span",{className:"font-bold text-blue-600",children:w.filter(b=>b.machineid===m.id&&b.date<=c).reduce((b,E)=>v(b,X(E)),0).toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Statement: "}),e.jsx("span",{className:"font-bold text-emerald-600",children:w.filter(b=>b.machineid===m.id&&b.date<=c).reduce((b,E)=>v(b,Z(E)),0).toFixed(2)})]})]})})]})]})}const M=W(m.id,c,w),V=X(u),z=Z(u),L=ue(u),o=re(m.id,c,w);return e.jsxs("div",{className:"bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow",onClick:O,children:[e.jsx("h3",{className:"font-bold text-lg text-blue-600 mb-3",children:m.name}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"bg-blue-50 p-2 rounded",children:[e.jsx("div",{className:"text-blue-600 font-medium mb-2 border-b border-blue-200 pb-1",children:"Slip"}),e.jsx(k,{label:"Mada",value:i(u.mada)}),e.jsx(k,{label:"Visa",value:i(u.visa)}),e.jsx(k,{label:"MC",value:i(u.mastercard)}),e.jsx(k,{label:"GCC",value:i(u.gcc)}),u.extrafields&&Object.entries(u.extrafields).map(([j,b])=>e.jsx(k,{label:j,value:i(b.slip)},`slip-${j}`)),e.jsx("div",{className:"border-t border-blue-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-blue-600",children:V.toFixed(2)})]})})]}),e.jsxs("div",{className:"bg-emerald-50 p-2 rounded",children:[e.jsx("div",{className:"text-emerald-600 font-medium mb-2 border-b border-emerald-200 pb-1",children:"Statement"}),e.jsx(k,{label:"Mada",value:i(u.bankmada)}),e.jsx(k,{label:"Visa",value:i(u.bankvisa)}),e.jsx(k,{label:"MC",value:i(u.bankmastercard)}),e.jsx(k,{label:"GCC",value:i(u.bankgcc)}),u.extrafields&&Object.entries(u.extrafields).map(([j,b])=>e.jsx(k,{label:j,value:i(b.statement)},`stmt-${j}`)),e.jsx("div",{className:"border-t border-emerald-200 pt-2 mt-2",children:e.jsxs("div",{className:"flex justify-between items-center font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{className:"text-emerald-600",children:z.toFixed(2)})]})})]})]}),e.jsxs("div",{className:"pt-2 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Opening: "}),e.jsx("span",{className:`font-bold ${M<0?"text-red-600":"text-green-600"}`,children:M.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Diff: "}),e.jsx("span",{className:`font-bold ${L<0?"text-red-600":"text-emerald-600"}`,children:(L>0?"+":"")+L.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Closing: "}),e.jsx("span",{className:`font-bold ${o<0?"text-red-600":"text-green-600"}`,children:o.toFixed(2)})]})]}),e.jsx("div",{className:"pt-2 border-t mt-2",children:e.jsxs("div",{className:"flex justify-between items-center text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Slip: "}),e.jsx("span",{className:"font-bold text-blue-600",children:w.filter(j=>j.machineid===m.id&&j.date<=c).reduce((j,b)=>v(j,X(b)),0).toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Statement: "}),e.jsx("span",{className:"font-bold text-emerald-600",children:w.filter(j=>j.machineid===m.id&&j.date<=c).reduce((j,b)=>v(j,Z(b)),0).toFixed(2)})]})]})})]})]})]})},Ce=xe.memo(({machine:m,date:u,amounts:w,records:c,initialExtraValues:O,onAmountChange:M,onSave:V,onCancel:z,onClear:L,extraFieldValues:o,setExtraFieldValues:j})=>{const[b,E]=h.useState({});h.useEffect(()=>{if(o&&Object.keys(o).length>0){const s={};Object.keys(o).forEach(t=>{const a=t.split(" ")[0].toLowerCase();le.includes(a)&&(s[a]=[...s[a]||[],t])}),E(s)}else E({})},[o]);const T=o,B=j,[_,P]=h.useState(!1),[S,ie]=h.useState(0),[$,G]=h.useState(u),[K,de]=h.useState(!1),ee=xe.useRef(null);h.useEffect(()=>{var s;(s=ee.current)==null||s.focus()},[]);const U=h.useMemo(()=>c.filter(s=>s.machineid===m.id).sort((s,t)=>s.date.localeCompare(t.date)),[c,m.id]);U[S],h.useEffect(()=>{G(u);const s=U.findIndex(t=>t.date===u);ie(s>=0?s:0)},[U,u]);const{closingBalance:R,currentDifference:Y,slipTotal:ce,statementTotal:J}=h.useMemo(()=>{const s=W(m.id,$,c),t=v(i(w.mada),i(w.visa),i(w.mastercard),i(w.gcc)),a=Object.values(T).reduce((f,p)=>v(f,i(p==null?void 0:p.slip)),0),n=v(t,a),l=v(i(w.bankMada),i(w.bankVisa),i(w.bankMastercard),i(w.bankGcc)),g=Object.values(T).reduce((f,p)=>v(f,i(p==null?void 0:p.statement)),0),r=v(l,g),x=ve(r,n);return{closingBalance:v(s,x),currentDifference:x,slipTotal:n,statementTotal:r}},[w,T,m.id,$,c]),te=s=>{const t=(b[s]||[]).length,a=`${s} ${t+2}`;E(n=>({...n,[s]:[...n[s]||[],a]}))},Q=(s,t)=>{E(a=>({...a,[s]:(a[s]||[]).filter(n=>n!==t)})),B(a=>{const n={...a};return delete n[t],n})},I=(s,t,a)=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(s.key)){s.preventDefault();const n=Array.from(document.querySelectorAll("input[data-r]"));let l;if(s.key==="ArrowRight"||s.key==="ArrowLeft"){const g=s.key==="ArrowRight"?a+1:a-1;l=n.find(r=>parseInt(r.dataset.r||"0")===t&&parseInt(r.dataset.c||"0")===g)}else{const g=n.filter(r=>parseInt(r.dataset.c||"0")===a);s.key==="ArrowDown"?l=g.filter(r=>parseInt(r.dataset.r||"0")>t).sort((r,x)=>parseInt(r.dataset.r||"0")-parseInt(x.dataset.r||"0"))[0]:l=g.filter(r=>parseInt(r.dataset.r||"0")<t).sort((r,x)=>parseInt(x.dataset.r||"0")-parseInt(r.dataset.r||"0"))[0]}l&&(l.focus(),l.select())}},se=async()=>{P(!0);try{await V(T)}catch(s){console.error("Save failed",s)}finally{P(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:s=>s.target===s.currentTarget&&z(),children:e.jsx("div",{className:"bg-white rounded-lg p-6 w-full max-w-xl mx-4",children:e.jsxs("form",{onSubmit:s=>s.preventDefault(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{type:"button",onClick:()=>{const s=new Date($);s.setDate(s.getDate()-1);const t=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;window.dispatchEvent(new CustomEvent("navigateToDate",{detail:{date:t,machineid:m.id}}))},className:"p-2 hover:bg-gray-100 rounded",children:e.jsx(me,{className:"w-5 h-5"})}),e.jsx("div",{className:"text-center",children:e.jsxs("h3",{className:"text-lg font-bold",children:[m.name," -",e.jsx("button",{type:"button",onClick:()=>de(!K),className:"text-blue-600 hover:text-blue-800",children:new Date($).toLocaleDateString("en-US",{weekday:"long",day:"numeric",month:"long",year:"numeric"})})]})}),e.jsx("button",{type:"button",onClick:()=>{const s=new Date($);s.setDate(s.getDate()+1);const t=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;window.dispatchEvent(new CustomEvent("navigateToDate",{detail:{date:t,machineid:m.id}}))},className:"p-2 hover:bg-gray-100 rounded",children:e.jsx(he,{className:"w-5 h-5"})})]}),K&&e.jsx("div",{className:"mb-4 bg-white rounded-lg shadow-xl border p-4",children:e.jsx("div",{className:"grid grid-cols-7 gap-1",children:(()=>{const s=new Date($),t=s.getFullYear(),a=s.getMonth(),n=new Date(t,a,1).getDay(),l=new Date(t,a+1,0).getDate(),g=[];for(let r=0;r<n;r++)g.push(e.jsx("div",{className:"aspect-square"},`empty-${r}`));for(let r=1;r<=l;r++){const x=`${t}-${String(a+1).padStart(2,"0")}-${String(r).padStart(2,"0")}`,d=c.find(y=>y.date===x&&y.machineid===m.id),f=x===$,p=!!d,C=re(m.id,x,c);g.push(e.jsx("button",{onClick:()=>{G(x),de(!1)},className:`aspect-square rounded text-sm transition-all
                          ${f?"bg-blue-600 text-white":"hover:bg-slate-100"}
                          ${p?C<0?"text-red-600 font-bold":"text-green-600 font-bold":""}
                        `,children:r},r))}return g})()})}),e.jsx("div",{className:"mb-4 bg-slate-50 p-3 rounded",children:e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Opening: ",e.jsx("strong",{className:(()=>W(m.id,$,c)<0?"text-red-600":"text-green-600")(),children:W(m.id,$,c).toFixed(2)})]}),e.jsxs("span",{children:["Difference: ",e.jsx("strong",{className:`${Y<0?"text-red-600":Y>0?"text-green-600":"text-slate-600"}`,children:(Y>0?"+":"")+Y.toFixed(2)})]}),e.jsxs("span",{children:["Closing: ",e.jsx("strong",{className:`${R<0?"text-red-600":"text-green-600"}`,children:R.toFixed(2)})]})]})}),e.jsxs("div",{className:"space-y-4 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-sm font-medium text-gray-600",children:[e.jsx("div",{children:"Card Type"}),e.jsx("div",{className:"text-center",children:"Slip Amount"}),e.jsx("div",{className:"text-center",children:"Statement Amount"})]}),le.map((s,t)=>{var a;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e.jsx("label",{className:"text-sm font-medium capitalize",children:s}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{type:"button",onClick:()=>te(s),className:"text-blue-500 hover:text-blue-600 w-7 h-7 flex items-center justify-center flex-shrink-0 text-sm font-bold",tabIndex:-1,children:"+"}),e.jsx("input",{ref:t===0?ee:null,type:"number",step:"0.01",placeholder:"0.00",value:w[s],onChange:n=>M(s,n.target.value),onKeyDown:n=>I(n,t*10,0),"data-r":t*10,"data-c":0,className:"w-full p-3 border rounded text-sm"})]}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:w[`bank${s.charAt(0).toUpperCase()+s.slice(1)}`],onChange:n=>M(`bank${s.charAt(0).toUpperCase()+s.slice(1)}`,n.target.value),onKeyDown:n=>I(n,t*10,1),"data-r":t*10,"data-c":1,className:"w-full p-3 border rounded text-sm"})]}),(a=b[s])==null?void 0:a.map((n,l)=>{var g,r;return e.jsxs("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e.jsxs("div",{className:"text-sm font-medium capitalize pl-8 flex items-center gap-2",children:[e.jsx("span",{children:n}),e.jsx("button",{type:"button",onClick:()=>Q(s,n),className:"text-red-500 hover:text-red-700 p-1",title:"Remove field",tabIndex:-1,children:e.jsx(Ne,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{type:"button",onClick:()=>te(s),className:"text-blue-500 hover:text-blue-600 w-7 h-7 flex items-center justify-center flex-shrink-0 text-sm font-bold",tabIndex:-1,children:"+"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:((g=T[n])==null?void 0:g.slip)||"",onChange:x=>B(d=>({...d,[n]:{...d[n],slip:x.target.value}})),onKeyDown:x=>I(x,t*10+l+1,0),"data-r":t*10+l+1,"data-c":0,className:"w-full p-3 border rounded text-sm"})]}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",value:((r=T[n])==null?void 0:r.statement)||"",onChange:x=>B(d=>({...d,[n]:{...d[n],statement:x.target.value}})),onKeyDown:x=>I(x,t*10+l+1,1),"data-r":t*10+l+1,"data-c":1,className:"w-full p-3 border rounded text-sm"})]},n)})]},s)}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-sm font-medium border-t pt-3 mt-4",children:[e.jsx("div",{}),e.jsxs("div",{className:"text-center text-blue-600",children:["Total: ",(le.reduce((s,t)=>v(s,i(w[t])),0)+Object.values(T).reduce((s,t)=>v(s,i(t==null?void 0:t.slip)),0)).toFixed(2)]}),e.jsxs("div",{className:"text-center text-emerald-600",children:["Total: ",(le.reduce((s,t)=>v(s,i(w[`bank${t.charAt(0).toUpperCase()+t.slice(1)}`])),0)+Object.values(T).reduce((s,t)=>v(s,i(t==null?void 0:t.statement)),0)).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:z,className:"flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{type:"button",onClick:L,className:"flex-1 bg-orange-500 text-white p-2 rounded hover:bg-orange-600",children:"Clear"}),e.jsx("button",{type:"button",onClick:se,disabled:_,className:`flex-1 p-2 rounded flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors ${_?"bg-green-600 text-white":"bg-blue-500 text-white hover:bg-blue-600"}`,children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-4 h-4"}),"Save"]})})]})]})})})}),Te=()=>{const{user:m}=pe(),[u,w]=h.useState([]),[c,O]=h.useState([]),[M,V]=h.useState(""),[z,L]=h.useState(!1),[o,j]=h.useState(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}),[b,E]=h.useState({openingBalance:"",mada:"",visa:"",mastercard:"",gcc:"",bankMada:"",bankVisa:"",bankMastercard:"",bankGcc:""}),[T,B]=h.useState({}),[_,P]=h.useState(!1),[S,ie]=h.useState(null),[$,G]=h.useState(!0),[K,de]=h.useState("");h.useState(!1),h.useState(-1),h.useState(!1);const[ee,U]=h.useState(!1),R=h.useMemo(()=>c.filter(t=>t.date===o),[c,o]);h.useEffect(()=>{ge()},[c]);const Y=h.useMemo(()=>c.map(t=>`${t.id}-${t.timestamp}`).join(","),[c]),ce=h.useMemo(()=>u.find(t=>t.id===M),[u,M]);h.useMemo(()=>K?c.filter(t=>[t.mada,t.visa,t.mastercard,t.gcc,t.bankmada,t.bankvisa,t.bankmastercard,t.bankgcc].some(a=>a&&a.toString().startsWith(K))).slice(0,10):[],[c,K]),h.useEffect(()=>{let t=!0;return m?(G(!0),(async()=>{try{const[n,l]=await Promise.all([fe(m.id),ne(m.id)]);t&&(w(n),O(l));const{getBusiness:g}=await H(()=>import("./index-b47b5198.js").then(x=>x.l),["assets/index-b47b5198.js","assets/vendor-26985c70.js","assets/router-3413067a.js","assets/supabase-101da91f.js","assets/ui-2e713e73.js","assets/index-487b52d1.css"]),r=await g(m.id);t&&(ie(r),G(!1))}catch(n){console.error("Error loading data:",n),t&&G(!1)}})(),()=>{t=!1}):(G(!1),()=>{t=!1})},[m]),h.useEffect(()=>{const t=a=>{const n=a.target;_&&!n.closest(".calendar-container")&&P(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[_]),h.useEffect(()=>{const t=()=>{O(g=>g.filter(r=>r.date!==o))},a=()=>{const g="\uFEFF",r=["Machine","Opening","Slip Mada","Slip Visa","Slip MC","Slip GCC","Bank Mada","Bank Visa","Bank MC","Bank GCC","Difference","Closing"],x=u.map(F=>{const N=R.find(D=>D.machineid===F.id),ae=c.filter(D=>D.machineid===F.id&&D.date<o).sort((D,A)=>A.date.localeCompare(D.date)),q=ae[0]?Number(ae[0].closingbalance||0):0;if(N){const D=Number(N.difference||0),A=q+D;return[F.name,q.toFixed(2),Number(N.mada||0).toFixed(2),Number(N.visa||0).toFixed(2),Number(N.mastercard||0).toFixed(2),Number(N.gcc||0).toFixed(2),Number(N.bankmada||0).toFixed(2),Number(N.bankvisa||0).toFixed(2),Number(N.bankmastercard||0).toFixed(2),Number(N.bankgcc||0).toFixed(2),D.toFixed(2),A.toFixed(2)]}else return[F.name,q.toFixed(2),"0.00","0.00","0.00","0.00","0.00","0.00","0.00","0.00","0.00",q.toFixed(2)]}),d=F=>{const N=String(F||"");return N.includes(",")||N.includes('"')||N.includes(`
`)?`"${N.replace(/"/g,'""')}"`:N},f=g+[r.join(","),...x.map(F=>F.map(d).join(","))].join(`
`),p=new Blob([f],{type:"application/vnd.ms-excel"}),C=URL.createObjectURL(p),y=document.createElement("a");y.style.display="none",y.href=C,y.download=`reconcile-${o}.csv`,y.setAttribute("type","text/csv"),document.body.appendChild(y),y.click(),setTimeout(()=>{document.body.removeChild(y),URL.revokeObjectURL(C)},100)},n=()=>{window.print()},l=async()=>{try{const{supabase:g}=await H(()=>import("./index-b47b5198.js").then(p=>p.k),["assets/index-b47b5198.js","assets/vendor-26985c70.js","assets/router-3413067a.js","assets/supabase-101da91f.js","assets/ui-2e713e73.js","assets/index-487b52d1.css"]),{deleteRecord:r}=await H(()=>import("./index-b47b5198.js").then(p=>p.l),["assets/index-b47b5198.js","assets/vendor-26985c70.js","assets/router-3413067a.js","assets/supabase-101da91f.js","assets/ui-2e713e73.js","assets/index-487b52d1.css"]),x=c.filter(p=>p.userid===(m==null?void 0:m.id)&&p.date===o);await Promise.all(x.map(p=>r(p.id)));const f=JSON.parse(localStorage.getItem("rpro_records")||"[]").filter(p=>p.date!==o);localStorage.setItem("rpro_records",JSON.stringify(f)),O(p=>p.filter(C=>C.date!==o))}catch(g){console.error("Error clearing records:",g),alert("Failed to clear records. Please try again.")}};return window.addEventListener("recordsCleared",t),window.addEventListener("exportToExcel",a),window.addEventListener("printDashboard",n),window.addEventListener("clearSelectedDate",l),()=>{window.removeEventListener("recordsCleared",t),window.removeEventListener("exportToExcel",a),window.removeEventListener("printDashboard",n),window.removeEventListener("clearSelectedDate",l)}},[o,u,R,c]);const J=()=>{E({openingBalance:"",mada:"",visa:"",mastercard:"",gcc:"",bankMada:"",bankVisa:"",bankMastercard:"",bankGcc:""}),B({}),V(""),L(!1)},te=h.useCallback(async t=>{if(!(!m||!M))try{const a=i(b.mada),n=i(b.visa),l=i(b.mastercard),g=i(b.gcc),r=i(b.bankMada),x=i(b.bankVisa),d=i(b.bankMastercard),f=i(b.bankGcc);let p=0,C=0;Object.values(t).forEach(D=>{const A=i(D.slip),oe=i(D.statement);p=v(p,A),C=v(C,oe)});const y=R.find(D=>D.machineid===M),F=a===0&&n===0&&l===0&&g===0&&r===0&&x===0&&d===0&&f===0&&p===0&&C===0;if(F&&y){const{deleteRecord:D}=await H(()=>import("./index-b47b5198.js").then(oe=>oe.l),["assets/index-b47b5198.js","assets/vendor-26985c70.js","assets/router-3413067a.js","assets/supabase-101da91f.js","assets/ui-2e713e73.js","assets/index-487b52d1.css"]);await D(y.id);const A=await ne(m.id);O(A),J();return}if(F){J();return}const N={};Object.entries(t).forEach(([D,A])=>{A&&(A.slip||A.statement)&&(N[D]={slip:i(A.slip),statement:i(A.statement)})});const ae={id:(y==null?void 0:y.id)||be(),userid:m.id,machineid:M,date:o,mada:a,visa:n,mastercard:l,gcc:g,bankmada:r,bankvisa:x,bankmastercard:d,bankgcc:f,extrafields:Object.keys(N).length>0?N:null,timestamp:Date.now()};await je(ae),ge();const q=await ne(m.id);O(q),J()}catch(a){console.error("Error saving record:",a),alert("Failed to save record. Please try again.")}finally{}},[m,M,b,R,o]),Q=h.useCallback((t,a)=>{const n=a||o,l=c.find(d=>d.machineid===t&&d.date===n);V(t);const r=c.filter(d=>d.machineid===t&&d.date<n).sort((d,f)=>f.date.localeCompare(d.date))[0],x=r?String(r.closingbalance||0):"0";if(l)if(E({openingBalance:x,mada:String(l.mada||""),visa:String(l.visa||""),mastercard:String(l.mastercard||""),gcc:String(l.gcc||""),bankMada:String(l.bankmada||""),bankVisa:String(l.bankvisa||""),bankMastercard:String(l.bankmastercard||""),bankGcc:String(l.bankgcc||"")}),l.extrafields&&Object.keys(l.extrafields).length>0){const d={};Object.entries(l.extrafields).forEach(([f,p])=>{const C=p;d[f]={slip:String(C.slip||""),statement:String(C.statement||"")}}),B(d)}else B({});else J(),V(t),E(d=>({...d,openingBalance:x})),B({});L(!0)},[c,o]);h.useEffect(()=>{const t=a=>{const n=a.detail;typeof n=="string"?j(n):(j(n.date),n.machineid&&setTimeout(()=>{Q(n.machineid,n.date),L(!0)},50)),P(!1)};return window.addEventListener("navigateToDate",t),()=>{window.removeEventListener("navigateToDate",t)}},[Q]);const I=h.useCallback((t,a)=>{E(n=>({...n,[t]:a}))},[]),se=h.useCallback(t=>{const a=new Date(o);a.setDate(a.getDate()+(t==="next"?1:-1));const n=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`;j(n)},[o]),s=h.useMemo(()=>{let t=0,a=0,n=0,l=0,g=0;return u.forEach(r=>{const x=R.find(f=>f.machineid===r.id),d=W(r.id,o,c);if(t=v(t,d),x){const f=re(r.id,o,c),p=ue(x),C=X(x),y=Z(x);a=v(a,f),n=v(n,p),l=v(l,C),g=v(g,y)}else a=v(a,d)}),{totalOpening:t,totalClosing:a,totalDiff:n,totalSlip:l,totalStatement:g}},[R,u,c,o]);return $?e.jsx("div",{className:"max-w-6xl mx-auto space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 text-center",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("div",{children:"Loading..."})]})}):e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsxs("div",{className:"print-header",children:[e.jsx("h1",{children:(S==null?void 0:S.name)||"Reconciliation Report"}),e.jsx("p",{children:new Date(o).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}),S&&e.jsxs("p",{children:[S.phone&&e.jsxs("span",{children:[S.phone," | "]}),S.email&&e.jsx("span",{children:S.email})]})]}),e.jsx("div",{className:"print-only",children:e.jsxs("table",{className:"print-table",children:[e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{children:"Machine"}),e.jsx("th",{children:"Opening"}),e.jsx("th",{colSpan:4,style:{textAlign:"center",borderBottom:"1px solid #ddd"},children:"Slip Totals"}),e.jsx("th",{colSpan:4,style:{textAlign:"center",borderBottom:"1px solid #ddd"},children:"Bank Totals"}),e.jsx("th",{children:"Difference"}),e.jsx("th",{children:"Closing"})]}),e.jsxs("tr",{children:[e.jsx("th",{}),e.jsx("th",{}),e.jsx("th",{children:"Mada"}),e.jsx("th",{children:"Visa"}),e.jsx("th",{children:"MC"}),e.jsx("th",{children:"GCC"}),e.jsx("th",{children:"Mada"}),e.jsx("th",{children:"Visa"}),e.jsx("th",{children:"MC"}),e.jsx("th",{children:"GCC"}),e.jsx("th",{}),e.jsx("th",{})]})]}),e.jsx("tbody",{children:u.map(t=>{const a=R.find(l=>l.machineid===t.id),n=W(t.id,o,c);if(a){const l=i(a.difference),g=v(n,l);return e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:"bold"},children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:n.toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.mada).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.visa).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.mastercard).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.gcc).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.bankmada).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.bankvisa).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.bankmastercard).toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:i(a.bankgcc).toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:l<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:(l>0?"+":"")+l.toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:g<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:g.toFixed(2)})]},t.id)}else return e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:"bold"},children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:n.toFixed(2)}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right"},children:"0.00"}),e.jsx("td",{style:{textAlign:"right",color:n<0?"#dc2626":"#16a34a",fontWeight:"bold"},children:n.toFixed(2)})]},t.id)})}),e.jsx("tfoot",{children:e.jsxs("tr",{style:{borderTop:"2px solid #000",fontWeight:"bold",fontSize:"11pt"},children:[e.jsx("td",{children:"TOTAL"}),e.jsx("td",{style:{textAlign:"right"},children:s.totalOpening.toFixed(2)}),e.jsxs("td",{colSpan:4,style:{textAlign:"center",borderRight:"1px solid #ddd"},children:["Slip: ",s.totalSlip.toFixed(2)]}),e.jsxs("td",{colSpan:4,style:{textAlign:"center",borderRight:"1px solid #ddd"},children:["Statement: ",s.totalStatement.toFixed(2)]}),e.jsx("td",{style:{textAlign:"right",color:s.totalDiff<0?"#dc2626":"#16a34a"},children:(s.totalDiff>0?"+":"")+s.totalDiff.toFixed(2)}),e.jsx("td",{style:{textAlign:"right",color:s.totalClosing<0?"#dc2626":"#16a34a"},children:s.totalClosing.toFixed(2)})]})})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 mb-6 no-print",children:[e.jsxs("div",{className:"md:hidden text-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:(S==null?void 0:S.name)||"My Business"}),S&&e.jsxs("div",{className:"text-sm text-slate-600 mt-1",children:[S.address&&e.jsxs("span",{children:[S.address," • "]}),S.phone&&e.jsxs("span",{children:[S.phone," • "]}),S.email&&e.jsx("span",{children:S.email}),S.taxId&&e.jsxs("div",{className:"mt-1",children:["Tax ID: ",S.taxId]})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-8 text-sm sm:text-base mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Opening:"}),e.jsx("span",{className:`font-semibold ${s.totalOpening<0?"text-red-600":"text-green-600"}`,children:s.totalOpening.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Difference:"}),e.jsx("span",{className:`font-semibold ${s.totalDiff<0?"text-red-600":"text-green-600"}`,children:(s.totalDiff>0?"+":"")+s.totalDiff.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Closing:"}),e.jsx("span",{className:`font-bold ${s.totalClosing<0?"text-red-600":"text-green-600"}`,children:s.totalClosing.toFixed(2)})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 border-t pt-4",children:[e.jsx("button",{onClick:()=>se("prev"),className:"p-3 hover:bg-slate-100 rounded",children:e.jsx(me,{className:"w-6 h-6"})}),e.jsxs("div",{onClick:()=>P(!_),className:"p-2 text-sm font-medium flex items-center gap-2 cursor-pointer hover:bg-slate-50 rounded transition-colors text-black whitespace-nowrap",children:[e.jsx(Se,{className:"w-4 h-4"}),new Date(o).toLocaleDateString("en-US",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]}),e.jsx("button",{onClick:()=>se("next"),className:"p-3 hover:bg-slate-100 rounded",children:e.jsx(he,{className:"w-6 h-6"})})]})]}),_&&e.jsxs("div",{className:"calendar-container mt-4 mb-6 bg-white rounded-lg shadow-xl border p-4 z-50 max-w-sm mx-auto no-print",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("button",{onClick:()=>{const t=new Date(o);t.setMonth(t.getMonth()-1);const a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;j(a)},className:"p-1 hover:bg-slate-100 rounded",children:e.jsx(me,{className:"w-4 h-4"})}),e.jsx("div",{className:"font-semibold",children:new Date(o).toLocaleDateString("en-US",{month:"long",year:"numeric"})}),e.jsx("button",{onClick:()=>{const t=new Date(o);t.setMonth(t.getMonth()+1);const a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;j(a)},className:"p-1 hover:bg-slate-100 rounded",children:e.jsx(he,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Su","Mo","Tu","We","Th","Fr","Sa"].map(t=>e.jsx("div",{className:"text-center text-xs font-medium text-slate-500 py-1",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:(()=>{const t=new Date(o),a=t.getFullYear(),n=t.getMonth(),l=new Date(a,n,1).getDay(),g=new Date(a,n+1,0).getDate(),r=(()=>{const d=new Date;return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`})(),x=[];for(let d=0;d<l;d++)x.push(e.jsx("div",{className:"aspect-square"},`empty-${d}`));for(let d=1;d<=g;d++){const f=`${a}-${String(n+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`,p=c.filter(N=>N.date===f),C=f===o,y=f===r;let F=0;u.forEach(N=>{F+=re(N.id,f,c)}),x.push(e.jsx("button",{onClick:()=>{j(f),P(!1)},className:`aspect-square rounded-lg text-sm font-medium transition-all relative
                      ${C?"ring-2 ring-blue-600 font-bold":"hover:bg-slate-100"}
                      ${y&&!C?"ring-2 ring-blue-300":""}
                      ${p.length>0?F<0?"text-red-600 font-bold":"text-green-600 font-bold":""}
                    `,children:d},d))}return x})()}),e.jsxs("div",{className:"flex items-center justify-center gap-4 mt-4 pt-4 border-t text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsx("span",{className:"text-slate-600",children:"Positive"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsx("span",{className:"text-slate-600",children:"Negative"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-400"}),e.jsx("span",{className:"text-slate-600",children:"Neutral"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 no-print",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:u.map(t=>e.jsx(ye,{machine:t,record:R.find(a=>a.machineid===t.id),records:c,date:o,onClick:()=>Q(t.id)},`${t.id}-${Y}`))}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow p-4 mt-4 no-print space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-8 text-base font-semibold",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Total Machines:"}),e.jsx("span",{className:"text-slate-800 text-lg",children:u.length})]}),e.jsx("div",{className:"h-6 w-px bg-slate-300"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Total Slip:"}),e.jsx("span",{className:"text-blue-600 text-lg",children:s.totalSlip.toFixed(2)})]}),e.jsx("div",{className:"h-6 w-px bg-slate-300"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"Total Statement:"}),e.jsx("span",{className:"text-purple-600 text-lg",children:s.totalStatement.toFixed(2)})]})]}),e.jsx("div",{className:"border-t pt-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-8 text-sm font-semibold",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"All Time Slip:"}),e.jsx("span",{className:"text-blue-700 text-base",children:(()=>c.filter(a=>a.date<=o).reduce((a,n)=>v(a,X(n)),0).toFixed(2))()})]}),e.jsx("div",{className:"h-6 w-px bg-slate-300"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-slate-600",children:"All Time Statement:"}),e.jsx("span",{className:"text-purple-700 text-base",children:(()=>c.filter(a=>a.date<=o).reduce((a,n)=>v(a,Z(n)),0).toFixed(2))()})]})]})})]},`summary-${Y}`)]}),ee&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-sm mx-4",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Clear Entry"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to clear this entry? This will delete all data for this machine on this date."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>U(!1),className:"flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300",children:"Cancel"}),e.jsx("button",{onClick:async()=>{const t=c.find(a=>a.machineid===M&&a.date===o);if(t){const{deleteRecord:a}=await H(()=>import("./index-b47b5198.js").then(n=>n.l),["assets/index-b47b5198.js","assets/vendor-26985c70.js","assets/router-3413067a.js","assets/supabase-101da91f.js","assets/ui-2e713e73.js","assets/index-487b52d1.css"]);if(await a(t.id),m){const n=await ne(m.id);O(n)}}Object.keys(b).forEach(a=>{a!=="openingBalance"&&I(a,"")}),B({}),U(!1)},className:"flex-1 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600",children:"Clear"})]})]})}),z&&ce&&e.jsx(Ce,{machine:ce,date:o,amounts:b,records:c,initialExtraValues:T,onAmountChange:I,onSave:te,onCancel:()=>L(!1),onClear:()=>U(!0),extraFieldValues:T,setExtraFieldValues:B})]})};export{Te as QuickEntry};
